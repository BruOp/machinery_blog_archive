











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="A list of common types of bugs."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/a-taxonomy-of-bugs.png"/>
  
  <meta name="twitter:title" content="A Taxonomy of Bugs">
  <meta name="twitter:description" content="A list of common types of bugs."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="A Taxonomy of Bugs Â· Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/a-taxonomy-of-bugs/"/>
  
  <meta property="og:image" content="../../images/a-taxonomy-of-bugs.png"/>
  
  
  <meta property="og:description" content="A list of common types of bugs."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2022-04-08T00:00:00Z"/>
  

  <title>A Taxonomy of Bugs &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" media="screen, print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" media="screen, print"/>
  

  
  
  <link href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    ga('set', 'anonymizeIp', true);
    
  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="../../js/page.min.js?v=1.16"></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20220502180503/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20220502180503\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Niklas Gray",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20220502180503\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "A Taxonomy of Bugs",
    "name": "A Taxonomy of Bugs",
    "wordCount":  7204 ,
    "timeRequired": "PT34M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/a-taxonomy-of-bugs/",
    "datePublished": "2022-04-08T00:00Z",
    "dateModified": "2022-04-08T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20220502180503/https://ourmachinery.com/a-taxonomy-of-bugs.png"
    },
    
    
    "description": "A list of common types of bugs."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
             
            
            
            
             
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/roadmap.html">Roadmap</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.github.io/themachinery-books/">Books</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/academic.html">Academic License</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220502180503/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.github.io/themachinery-books/" aria-label="Opens Books" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Books</span></a>
        <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>A Taxonomy of Bugs</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2022-04-08T00:00:00Z">
          Apr 8, 2022
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>Debugging is often an undervalued skill. It&rsquo;s not really taught in schools (as far as I know),
instead, you kind of have to pick it up as you go along. Today, I&rsquo;ll try to remedy that by looking
at some common bugs and what to do about them.</p>
<p>The default strategy I use with any bug is to:</p>
<ol>
<li>Try to find a way of reliably reproducing the bug so that I can</li>
<li>break into the debugger when the bug happens and</li>
<li>step through the code line by line to</li>
<li>see how what it <em>is</em> doing differs from what I <em>think</em> it should be doing.</li>
</ol>
<p>Once you understand how the code&rsquo;s <em>actual</em> behavior differs from your <em>mental model</em> of its
behavior, it is typically easy to identify the problem and fix it.</p>
<p>I know that there are some very successful programmers that don&rsquo;t really use debuggers but instead
rely completely on <code>printf()</code> and logging. But I don&rsquo;t really understand <em>how</em> they do it. Trying
to understand what the code is doing by inserting one <code>printf()</code> at a time and then re-running the
tests seems so much more inefficient than using a debugger. If you&rsquo;ve never really used a debugger
(I know, they don&rsquo;t teach these things in school), I suggest you try it! Get comfortable with
stepping through the code and examining what it does.</p>
<p>Of course, there are some situations where you <em>can&rsquo;t</em> capture the bug in the debugger and have to
resort to other methods, but we&rsquo;ll get to that later, so let&rsquo;s get started.</p>
<h2 id="the-typo">The Typo</h2>
<p>Unlike most other bugs, the <em>Typo</em> is not caused by any flawed reasoning. You had the right idea,
you just happened to type something else. Luckily, most typos are caught by the compiler, but
sometimes your boo-boos compile:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (set_x)
   pos.x <span style="color:#f92672">=</span> new_pos.x;
<span style="color:#66d9ef">if</span> (set_y)
   pos.x <span style="color:#f92672">=</span> new_pos.y;
<span style="color:#66d9ef">if</span> (set_y)
   pos.z <span style="color:#f92672">=</span> new_pos.z;
</code></pre></div><p>Once you <em>see</em> them, typos are trivial to fix. The hard part is seeing them in the first place.</p>
<p>Typos can be hard to spot because just as when you read text with spelling errors, your brain
auto-corrects the code as you read it. To be good at proofreading, you have to force your brain to
go into a different mode where it focuses more on the <em>text itself</em> than the <em>meaning of the text</em>.
This can be tricky, but you get better with practice.</p>
<p>If you can&rsquo;t spot the typo just from reading the code, you can switch to our default debugging
method â stepping through the code line by line and checking that each line does what you expect
it to.</p>
<p>How can you prevent typos? It might seem that there is nothing you can do. Your brain will just
glitch every once in a while and there is nothing you can do to stop it.</p>
<p>I don&rsquo;t believe in such fatalism. Instead, I subscribe to the philosophy of <em>continuous small
improvements</em>. The goal is not to be perfect, the goal is to do a little better each day and over
time the accumulation of all those small improvements will add up to big gains.</p>
<p>So let&rsquo;s try again. <em>How can you make typos a little less likely?</em></p>
<p>First, you should enable as many compiler warnings as possible and also tell the compiler to
treat warnings as errors. The goal is to have the compiler detect as many typos as possible so that
you can fix them before they turn into actual bugs.</p>
<p>A warning that makes a big difference for me is <code>-Wshadow</code>. <code>-Wshadow</code> makes it an error to reuse a
variable name in a sub-scope. This prevents stupid mistakes like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> test <span style="color:#f92672">=</span> x;
{
   <span style="color:#66d9ef">int</span> test <span style="color:#f92672">=</span> f();
   g(test); <span style="color:#75715e">// &lt;-- Meant to use `test` from outer scope.
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Before I enabled <code>-Wshadow</code>, I made a lot of these mistakes. Mostly with very generic variable
names, such as <code>i</code> or <code>x</code>.</p>
<p>Second, use a source code formatter and run all your source code through it. We use
<code>clang-format</code> and run it automatically on <em>Save</em> and <code>git commit</code>. The source code formatter can
sometimes reveal typos. For example, if you type this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (x <span style="color:#f92672">&gt;</span> max);
  max <span style="color:#f92672">=</span> x;
</code></pre></div><p>the source code formatter will change it to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (x <span style="color:#f92672">&gt;</span> max)
    ;
max <span style="color:#f92672">=</span> x;
</code></pre></div><p>Which makes the bug more obvious.</p>
<p>Another thing you can do is to write things in a way that produces fewer typos. For example, I
used to write for-loops like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">for</span> (uint32_t i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>tm_carray_size(items); <span style="color:#f92672">++</span>i) {
   child_t <span style="color:#f92672">*</span>children <span style="color:#f92672">=</span> get_children(items[i]);
   <span style="color:#66d9ef">for</span> (uint32_t j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; j<span style="color:#f92672">&lt;</span>tm_carray_size(children); <span style="color:#f92672">++</span>j)
    ...
}
</code></pre></div><p>However, I noticed that this would often result in typos where I would write <code>children[i]</code> instead
of <code>children[j]</code>. So I started changing to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">for</span> (uint32_t item_i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; item_i<span style="color:#f92672">&lt;</span>tm_carray_size(items); <span style="color:#f92672">++</span>item_i) {
   child_t <span style="color:#f92672">*</span>children <span style="color:#f92672">=</span> get_children(items[item_i]);
   <span style="color:#66d9ef">for</span> (uint32_t child_i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; child_i<span style="color:#f92672">&lt;</span>tm_carray_size(children); <span style="color:#f92672">++</span>child_i)
    ...
}
</code></pre></div><p>With this, I&rsquo;m much less likely to write <code>children[item_i]</code>. These days, I&rsquo;ve switched to just
iterating over the pointers instead:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> item_t <span style="color:#f92672">*</span>i <span style="color:#f92672">=</span> items, <span style="color:#f92672">*</span>ie <span style="color:#f92672">=</span> tm_carray_end(items); i <span style="color:#f92672">!=</span> ie; <span style="color:#f92672">++</span>i) {
   child_t <span style="color:#f92672">*</span>children <span style="color:#f92672">=</span> get_children(<span style="color:#f92672">*</span>i);
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> child_t <span style="color:#f92672">*</span>c <span style="color:#f92672">=</span> children, <span style="color:#f92672">*</span>ce <span style="color:#f92672">=</span> tm_carray_end(children); c <span style="color:#f92672">!=</span> ce; <span style="color:#f92672">++</span>c)
      ...
}
</code></pre></div><p>Since <code>i</code> and <code>c</code> now have different types, it is impossible to confuse them. And if I would
accidentally write <code>*ce = tm_carray_end(items)</code> this would also give a compile error.</p>
<p>Everybody makes different typos, so find defensive strategies that work with the kind of typos you
usually make. A general tip is to use const for variables that don&rsquo;t change:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">const</span> uint32_t n <span style="color:#f92672">=</span> tm_carray_size(items);
</code></pre></div><p>This prevents you from accidentally changing the variable later.</p>
<p>Finally, a pretty common source of typos for me is when I copy-paste some code but don&rsquo;t patch it
up correctly. The first code snippet above is an example of that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (set_x)
   pos.x <span style="color:#f92672">=</span> new_pos.x;
<span style="color:#66d9ef">if</span> (set_y)
   pos.x <span style="color:#f92672">=</span> new_pos.y;
<span style="color:#66d9ef">if</span> (set_y)
   pos.z <span style="color:#f92672">=</span> new_pos.z;
</code></pre></div><p>I copy-pasted the first two lines and then forgot to change one of the <code>x</code> to an <code>y</code>. But I don&rsquo;t
want to <em>stop</em> copy-pasting, it saves a lot of time. I&rsquo;m also not sure that hand-typing repetitive
code would really reduce the error rate.</p>
<p>I&rsquo;ve found two things that help with this. The first is the multi-select feature that is
available in many modern code editors, such as VS Code. Using that, I would first paste the code
and then multi-select all three <code>x</code>s by selecting the first one and pressing <code>Ctrl-D</code> repeatedly
until they all are selected and then finally change them all to <code>y</code> with a single keystroke.</p>
<p>The second is <a href="http://web.archive.org/web/20220502180503/https://copilot.github.com/">Copilot</a>, the AI-assisted auto-completion
technology from GitHub. Copilot is <em>great</em> at recognizing repetitive programming patterns like this
and I find that having Copilot autofill in the code is <em>less</em> error-prone than copy-pasting and
tidying it up by hand. I&rsquo;m not willing to let an AI drive my car just yet, but I&rsquo;m willing to have
it write my repetitive code for me. If you haven&rsquo;t tried out Copilot yet, I suggest you do.</p>
<h2 id="the-logical-error">The Logical Error</h2>
<p>The <em>Logical Error</em> is perhaps the thing you mostly think of when you think <em>bug</em>. A logical error
occurs when the code you wrote doesn&rsquo;t actually do the thing you meant for it to do.</p>
<p>A common example is the <em>off-by-one</em> error, where you do one thing more or one thing less than you
should. For example, this code for removing an item from an array:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">memmove(arr <span style="color:#f92672">+</span> i, arr <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, (num_items <span style="color:#f92672">-</span> i) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>arr));
<span style="color:#f92672">--</span>num_items;
</code></pre></div><p>The nice thing about logical errors is that once you have a repro case it tends to be 100 %
reproducible because the code behaves the same every time. So you can usually figure out what&rsquo;s
going on by stepping through the code.</p>
<p>To reduce the risk of logical errors, the first thing you can do is to simplify your
expressions. The simpler and easier the code is to read, the smaller is the chance that youâll
get confused about the logic.</p>
<p>Another thing that helps is to reduce the number of possible paths through the code. I.e.
instead of something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Fast path for removing the last item in the array.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> num_items <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
   <span style="color:#f92672">--</span>num_items;
<span style="color:#66d9ef">else</span> {
   <span style="color:#f92672">--</span>num_items;
   memmove(arr <span style="color:#f92672">+</span> i, arr <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, (num_items <span style="color:#f92672">-</span> i) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>arr));
}
</code></pre></div><p>just call the <code>memmove()</code> every time and count on the fact that a <code>memmove()</code> of zero bytes will
still be pretty fast.</p>
<p>Why? Well, to begin with, having less code means a smaller risk for bugs. But more importantly, if
you have code paths that only occasionally get exercised, they won&rsquo;t get as much testing as the
rest of the code. A bug could hide there and sneak past your quick tests only to blow up in
production.</p>
<p>In general, strive for linear code â code that progresses in a logical fashion from one line
to the next, that you can read as a coherent story instead of having to jump around in the code a
lot to understand what is going on.</p>
<p>Another thing that can help is to use standard idioms. For example, if you need to erase items
a lot, you can introduce a macro for it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define array_erase_item(a, i, n) \
</span><span style="color:#75715e">    (memmove((a) + (i), (a) + (i) + 1, ((n) - (i) - 1) * sizeof(*(a)), --(n))
</span></code></pre></div><p>Now if there is a logic error, the error will be in a single place and can be fixed more easily.</p>
<h2 id="the-unexpected-initial-condition">The Unexpected Initial Condition</h2>
<p>Another possibility is that your logic is flawless, but your code still fails, because the initial
state of the data was one you didn&rsquo;t expect. I.e., if the data had been in the state you had
expected, everything would have worked out fine, but since it wasn&rsquo;t, the algorithm failed:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">flag_t flags[MAX_FLAGS];
uint32_t num_flags;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_flag</span>(flag_t flag) {
    flags[num_flags<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> flag;
}
</code></pre></div><p>The code above works well under the assumption that <code>num_flags &lt; MAX_FLAGS</code>, but otherwise it will
write beyond the end of the array.</p>
<p>Does this mean that the code should be rewritten to use dynamically allocated memory to remove the
<code>MAX_FLAGS</code> limit? No, not necessarily. It is <em>perfectly fine</em> to have limits in what you support,
in fact, all code does. If you switched to a dynamically allocated array, the code would still fail
if you had more than <code>UINT32_MAX</code> flags. And if you changed <code>num_flags</code> to an <code>uint64_t</code> or some
kind of &ldquo;bignum&rdquo; you would still eventually run out of memory at some point.</p>
<p>If you don&rsquo;t ever expect to have more than a handful of flags, it is perfectly fine to have a
<code>MAX_FLAGS</code> of <code>32</code> or something similar.</p>
<p>The best way of dealing with unexpected initial conditions is to make your expectations
explicit. Some languages have facilities for this built into the language in the form of
<em>preconditions</em> that you can specify for a function. In C, the best way is through an assert:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">flag_t flags[MAX_FLAGS];
uint32_t num_flags;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_flag</span>(flag_t flag) {
    assert(num_flags <span style="color:#f92672">&lt;</span> MAX_FLAGS);
    flags[num_flags<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> flag;
}
</code></pre></div><p>Sometimes it can be unclear who is responsible for the bad initial condition. Is it the fault of
the function for not handling that special case or is it the fault of the caller for sending the
function bad data? Clearly documenting the acceptable initial conditions and adding asserts to
detect them puts the responsibility on the caller.</p>
<h2 id="the-memory-leak">The Memory Leak</h2>
<p>A memory leak occurs when your code allocates memory that it never frees. Memory leaks are not the
only leaks you have to worry about, code can also leak other things like <em>threads</em>, <em>critical
sections</em>, or <em>file handles</em>. But memory leaks are by far the most common ones, so let&rsquo;s focus on
that.
In C and C++, the standard way to allocate memory is to just call <code>malloc()</code> or <code>new</code> to get some
memory from the system allocator. Many other languages have a similar approach where creating an
object will allocate some memory from a global allocator.</p>
<p>Finding and fixing memory leaks in such setups is really hard. First, you typically don&rsquo;t even know
that there&rsquo;s a memory leak until you completely run out of system memory or notice in the <em>Task
Manager</em> that you are using gigabytes more than you expect. Smaller memory leaks will probably
never be detected or fixed.</p>
<p>Second, to fix it, you need to find out who allocated memory that they never released. That is
really hard because in the code, you just have a bunch of sprinkled <code>malloc()</code> and <code>free()</code> calls
â how are you supposed to know where a <code>free()</code> is missing?</p>
<p>In languages with <em>automated memory management</em> â garbage collection or reference counting â
this is less of a problem because in these languages the memory is automatically freed when there
are no more references to it. However, this does not completely get rid of leaks. Instead, it will
trade <em>memory leaks</em> for <em>reference leaks</em>, where someone holds a reference to something they
should have let go of. This reference keeps the object alive, sometimes a whole tree of objects,
wasting memory.</p>
<p>Reference leaks can be even harder to deal with than memory leaks. Manual memory management forces
you to be explicit about who <em>owns</em> a piece of memory, so if that piece of memory doesn&rsquo;t get
released, you will know who is at fault. With automatic memory management, there is no single
designated owner, anyone can hold a reference that keeps the memory alive.</p>
<p>The best way of dealing with memory (and other resource) leaks is to add instrumentation to
memory allocations. I.e., instead of calling <code>malloc()</code> directly, you call a wrapper function
that lets you pass in some extra parameters. For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">item_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> my_malloc(<span style="color:#66d9ef">sizeof</span>(item_t), __FILE__, __LINE__);
</code></pre></div><p><code>my_malloc()</code> can use this extra information to record all memory allocations: the size, pointer,
file name, and line number where the allocation happened. A corresponding <code>my_free()</code> function can
record all the <code>free()</code> calls. We can then dump all the calls to a log (or analyze them in some
other way) to find memory leaks. If someone is allocating memory without freeing it, we can pinpoint
the file name and line number where that happens which is usually enough to figure out the bug.
Recording all the memory calls has a bit of overhead, so you might want to save that for special
&ldquo;Instrumental&rdquo; builds, especially if you have lots of small memory allocations. (Which you should
generally try to avoid.)</p>
<p>In <em>The Machinery</em>, we go one step further. Instead of having a single global allocator that
everything goes through, each system in the engine has its own allocator. In many cases, the system
allocator just forwards the allocation calls to the global allocator, but the advantage of having a
system-specific allocator is that we can keep track of the total allocated memory in that system
without much overhead (we just add the allocated size to a counter and subtract on free). This
allows us to easily see the amount of memory used in each system. Also, when a system is shut down,
we make sure that the memory counter is at zero. If not, we report a memory leak in that system and
the user can do a more detailed analysis by using an instrumented build for that system.</p>
<p>With this approach, the problem of memory leaks almost completely disappears. We will still
occasionally create memory leaks because we are human and errors happen, but they get detected and
fixed quickly.</p>
<h2 id="the-memory-overwrite">The Memory Overwrite</h2>
<p>A memory overwrite happens when a piece of code writes to some memory location that it doesn&rsquo;t own.
There are typically two cases where this happens.</p>
<ul>
<li>&ldquo;Write after free&rdquo; is when the system writes to a pointer after freeing it.</li>
<li>&ldquo;Buffer overflow&rdquo; is when the system writes beyond the end of an array that it has allocated.</li>
</ul>
<p>The biggest problem with memory overwrite bugs is that they usually don&rsquo;t manifest immediately.
Instead, they might blow up later, in a completely different part of the code. In the <em>write after
free</em> case, the system allocator might have recycled the freed memory and allocated it to somebody
else. The write operation will then trash that system&rsquo;s data which might cause a crash or a weird
behavior when that system tries to use it.</p>
<p>In the <em>buffer overflow</em> case, most commonly the code will write over the bytes immediately after
the allocated memory. Typically, those bytes are used by the memory allocator to store various
kinds of bookkeeping data, for example, to link memory blocks together in chains. The write will
trash that data which will usually cause a crash inside the memory allocator at some later point
when it tries to use the data.</p>
<p>Since the crash happens in a completely different part of the code than where the bug originated it
can be hard to pin down the problem.</p>
<p>The tell-tale sign of a memory overwrite bug is that you get lots of weird crashes in different
parts of the code, often in the memory allocator itself, and when you look at the data it looks
trashed.
Some managed languages make memory overwrites impossible by completely preventing code from
accessing memory that it doesn&rsquo;t &ldquo;own&rdquo;. But note that this also often limits what the language can
do. For example, it can be hard or impossible to write a custom memory allocator in such languages.</p>
<p>Sometimes you can guess where the problem might be by the pattern of where the crashes occur.
Another thing you might try is to turn off big parts of the application to try to pinpoint it. For
example, if the bug disappears when you disable sound, you can suspect that the issue is in the
sound system. If the bug appeared recently, you can also try <code>git bisect</code> to find the commit that
introduced it.</p>
<p>But these are pretty blunt instruments. It would be much better if we could capture the bug <em>as it
happens</em> instead of having things blow up later.</p>
<p>In <em>The Machinery</em>, we have a method for doing just that. Remember how I said we use custom
allocators everywhere. To catch memory overwrite bugs, we switch out our standard allocator for an
<em>End-Of-Page</em> allocator. This allocator does not use <code>malloc()</code>, instead, it allocates whole pages
of memory directly from the VM and it positions the memory the user requested at the very end of
the memory page (hence the name <em>end-of-page</em> allocator):
A</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Aligning an allocation to the end of the pages." src="../../images/a-taxonomy-of-bugs.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Aligning an allocation to the end of the pages.</h4>
    </figcaption>
  </figure>
<p>In code this just looks something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">const</span> uint64_t size_up <span style="color:#f92672">=</span> (size <span style="color:#f92672">+</span> page_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> page_size <span style="color:#f92672">*</span> page_size;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>base <span style="color:#f92672">=</span> tm_os_api<span style="color:#f92672">-&gt;</span>virtual_memory<span style="color:#f92672">-&gt;</span>map(size_up);
<span style="color:#66d9ef">const</span> uint64_t offset <span style="color:#f92672">=</span> size_up <span style="color:#f92672">-</span> size;
<span style="color:#66d9ef">return</span> base <span style="color:#f92672">+</span> offset;
</code></pre></div><p>Similarly, when we free the memory, we free the whole page.</p>
<p>Since <code>free()</code> now completely unmaps the memory in the VM, writing after free will no longer trash
some other poor system&rsquo;s data. Instead, it will cause an immediate <em>access violation</em>. This means
that you no longer will have to play the guesswork of trying to figure out where the bad write came
from, you will get an access violation at the exact point in the code where it happened. And from
there, figuring out the bug is usually straightforward.</p>
<p>Similarly, since we positioned the allocation at the very end of the page, a buffer overflow will
go into the next page, which has not been mapped and again trigger an access violation.</p>
<p>Since we started to use this strategy we haven&rsquo;t really had any big issues with memory overwrite
bugs. They still happen from time to time, but when we notice the tell-tale signs, we can usually
find them and squash them quickly by enabling the end-of-page allocator.</p>
<h2 id="the-race-condition">The Race Condition</h2>
<p>I&rsquo;ll use <em>race condition</em> as a common name for any kind of multithreading bug. Race conditions
occur when different threads touch the same data and their changes interact in unexpected ways.</p>
<p>Race conditions can be tricky because they are timing-related. I.e., the bug may only happen if two
threads happen to touch the exact same thing at the exact same time. That could mean that the bug
shows up on one machine, but not on another. It can also mean that if you add some print statements
to figure out what is going on, the timing changes and the bug disappears. Which can be really
frustrating.</p>
<p>They can also be tricky because multi-threaded code is hard to reason about. Especially in this day
and age when the code you write can be reordered by the compiler <em>or</em> the CPU.</p>
<p>So what can you do about threading bugs?</p>
<p>Well, you could use a language that eliminates the possibility of race conditions. Yes,
Rust-gals and Rust-guys, this is the moment you have been waiting for! This is your time to shine!</p>
<p>Rust kind of ingeniously gets rid of most (not all) threading issues by keeping track of who has
the right to <em>write</em> to every piece of data and making sure that no two threads simultaneously have
write access to the same piece of data.</p>
<p>Rust aficionados argue that since the future will be more and more multi-threaded and since
multi-threaded code without these kinds of checks is too hard to write, Rust is the future of
systems programming. I&rsquo;m not convinced. I value simplicity a lot and Rust seems like a very
complicated language, but we will see.</p>
<p>Barring Rust, what else can you do about these bugs?</p>
<p>Well first, it pays to make sure that you are <em>actually</em> looking at a threading bug and not
something else. I like to have a flag in each system that forces it to go single-threaded. That
way, it&rsquo;s a fairly quick check to see if disabling the multi-threading resolves the issue. If so,
you can suspect a threading bug and start to dig deeper.</p>
<p>The next step might be to insert some extra critical sections into suspicious parts of the code to
force it to run one thread at a time. If that fixes it, you can suspect that there&rsquo;s a problem with
the multithreading logic in that part of the code.</p>
<p>But race conditions are always tricky to fix. The best thing is if you can prevent them from
happening in the first place.</p>
<p>A good way of doing that is to simplify your threading code. I find multi-threaded code really
hard to reason about. With single-threaded code, you can just step through it in your head
line-by-line. With multi-threaded code, you have to consider <em>every possible order the threads
might execute the instructions, including possible reorderings by the compiler or the CPU</em>. That&rsquo;s
a lot of permutations for one little brain to deal with.</p>
<p>So don&rsquo;t try to be fancy with multi-threaded code. Don&rsquo;t try to implement clever lock-free
algorithms unless you are <em>really, really, really, really, really</em> sure that you need it. Stick to
a few well-known patterns and use them throughout the code.</p>
<p>A good example of this is Go. Go doesn&rsquo;t have the same multi-threading safety features as Rust
does. But the multi-threading model that Go encourages with goroutines and channels is simple to
understand and pushes users towards safe multi-threaded programming patterns even if it doesn&rsquo;t
completely eliminate the possibility of error.</p>
<p>Another useful tool to have in your race condition arsenal is Clang&rsquo;s <a href="http://web.archive.org/web/20220502180503/https://clang.llvm.org/docs/ThreadSanitizer.html">thread
sanitizer</a>. The thread sanitizer can alert you
to many possible race conditions before they happen.</p>
<h2 id="the-design-flaw">The Design Flaw</h2>
<p>Sometimes the problem is not a bug in a particular piece of the code, the problem is that <em>the code
cannot possibly work, no matter how you write it</em>, because the whole thinking behind it is flawed.
This may sound weird, so let&rsquo;s look at a simple example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// If `s` is not HTML-encoded, adds HTML-encoding (&amp;lt; etc) to `s` and
</span><span style="color:#75715e">// returns it, if `s` is already HTML-encoded, returns it unchanged.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ensure_html_encoded</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s);
</code></pre></div><p>At first glance, this may seem reasonable, but the thinking behind this function is flawed. The
problem is that there is no way of telling whether a string is HTML-encoded or not. The string
<code>&amp;lt;</code> might either be an HTML-encoded version of the string <code>&lt;</code> <em>or</em> it might be that the user
<em>actually</em> wanted to take the string <code>&amp;lt;</code> and HTML-encode <em>that</em>!</p>
<p>This design flaw could lie buried in a program for a really long time until one day someone tries
to use <code>ensure_html_encoded()</code> to encode a string that <em>looks like</em> an already HTML-encoded string
and then the whole thing will blow up.</p>
<p>There is no way of fixing this by changing the implementation of <code>ensure_html_encoded()</code>. The only
way to fix it is to change the design itself and replace <code>ensure_html_encoded()</code> with something like
<code>html_encode()</code> that <em>always</em> HTML-encodes the input string, whether it looks like it&rsquo;s already
HTML-encoded or not.</p>
<p>But you can&rsquo;t simply replace all the calls to <code>ensure_html_encoded()</code> with calls to <code>html_encode()</code>,
because some of the strings passed in to <code>ensure_html_encoded()</code> might be already encoded, if you
call <code>html_encode()</code> on them, they will be doubly encoded. Instead, you must <em>overhaul the entire
logic</em> of HTML-encoding and make sure you properly keep track of what is HTML-encoded and what isn&rsquo;t.</p>
<p>Design flaw bugs can be tricky, especially for beginning programmers, because they require you to
take a step and look at the bigger picture and realize that the problem is not the particular bug
that you are trying to fix, the problem is that the whole thinking is flawed.</p>
<p>The example above is pretty simple, design flaws can get a lot hairier and harder to spot than
this. A pretty common case is that you have a function <code>f()</code> that gets called from two (or more)
places <code>g()</code> and <code>h()</code>, where <code>g()</code> and <code>h()</code> expect <code>f()</code> to do its thing a little bit differently
(the documentation doesn&rsquo;t exactly specify what <code>f()</code> does). The author of <code>g()</code> files a bug report
about <code>f()</code>&rsquo;s behavior, but fixing that bug breaks <code>h()</code> who then files a new bug report, that can
only be fixed by breaking things for <code>g()</code>, etc. In the end, the only solution is splitting <code>f()</code>
into two separate functions <code>f_a()</code> and <code>f_b()</code> that do similar but slightly different things.</p>
<p>There is no easy way of finding design flaws, the best you can do is to take a step back and
carefully consider the unstated assumptions that may exist about what a piece of code does and
make sure to change those unstated assumptions to stated assumptions.</p>
<p>Similarly, there is no easy way of fixing design flaws. Depending on how big the issue is and how
often the code gets called, it may require a big refactor.</p>
<h2 id="the-third-party-bug">The Third-Party Bug</h2>
<p>The third-party bug is a bug that&rsquo;s not in your code, but in someone else&rsquo;s code that you happen to
be using. You might think that the third-party bug shouldn&rsquo;t be your problem because it&rsquo;s <em>not your
fault!</em> But guess what, if the bug is preventing your software from working, it <em>is</em> your problem.
Sucks to be you!</p>
<p>Third-party bugs fall into a variety of different categories:</p>
<ul>
<li>There might be a genuine bug in the third-party library that you are using.</li>
<li>You might be using the library in the wrong way, so actually, it <em>is</em> your fault.</li>
<li>The documentation for the third-party library might not be very clear about exactly how it&rsquo;s supposed to behave in certain situations, making it unclear if there&rsquo;s a bug or not. The makers of the third-party library might not even know.</li>
</ul>
<p>When it comes to fixing third-party bugs, there are three possible situations you can find yourself
in:</p>
<ol>
<li>The creators of the third-party library respond quickly to the bug report and help you resolve
the situation.</li>
<li>The creators are not really that responsive, but you have the source code to the library, so you
can try to diagnose what is going on and fix it yourself.</li>
<li>The creators are not responsive and you don&rsquo;t have the source code, you are essentially dealing
with a black box.</li>
</ol>
<p>When it comes to <em>The Machinery</em>, we try to be in category 1. In addition, if you have a Pro
license, you also have the source code.</p>
<p>If you&rsquo;re in the second case where you have the source code but little or no support, you&rsquo;re faced
with the task of understanding how somebody else&rsquo;s source code works. This can be anywhere from
relatively easy to crazy hard depending on the state and quality of that code. It&rsquo;s also its own
special kind of skill that you can get better at with time.</p>
<p>The third case can be extremely frustrating. If you are faced with trying to debug a black box, the
only thing you can do is to try to poke it in various ways to see what happens. If you are lucky,
you might be able to make an accurate enough mental model of the black box to fix the bug. Maybe
some of the flags don&rsquo;t work the way the documentation says they work. Maybe the function crashes
on certain types of input. Perhaps you can write a little loop that calls the black box with all
kinds of different values to figure out what triggers the issue. Good luck!</p>
<h2 id="the-failed-specification">The Failed Specification</h2>
<p>Guess what, sometimes <em>you</em> are the third party. Oh, how the tables have turned!</p>
<p>Of course, when <em>you</em> wrote the function that somebody <em>else</em> is calling, your perspective
completely changes. Instead of an inscrutable black box that reacts in completely incomprehensible
ways to perfectly sensible input, you now see an army of ignorant users calling your functions in
the wrong order with a combination of parameters that <em>make no sense at all</em>.</p>
<p>But if you want to be a successful library writer, you shouldn&rsquo;t regard this as just a <em>user
error</em>. Instead, you should view it as a <em>failure of communication</em>. You failed to communicate to
the users how to properly use your API.</p>
<p>What can you do about that? You can provide better documentation or working code samples
that show how to use the API.</p>
<p>But even better is to design the API to prevent misuse, or at least, make sure that misuse
results in a decipherable error message.</p>
<p>How do you design to prevent misuse? Make sure that each function has a clear, single purpose that
is easy to understand. Don&rsquo;t have functions completely change behavior based on what
arguments/flags are passed in. Avoid designs that require functions to be called in a certain order
or that require the system to be in a certain &ldquo;state&rdquo;. Of course, these things can&rsquo;t always be
avoided, but minimize them as much as you can. Make use of the type system to prevent your API from
being used in the &ldquo;wrong&rdquo; way.</p>
<p>Let&rsquo;s look at an example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Begins a profiling scope.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">profiler_begin_scope</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name);

<span style="color:#75715e">// Ends a profiling scope started with [[profiler_begin_scope()]].
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">profiler_end_scope</span>();
</code></pre></div><p>Looks decent, but there is a potential for misuse. What if someone calls <code>profiler_end_scope()</code>
without having started a scope first.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Begins a profiling scope.
</span><span style="color:#75715e"></span>profiler_scope_t <span style="color:#a6e22e">profiler_begin_scope</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name);

<span style="color:#75715e">// Ends a profiling scope started with [[profiler_begin_scope()]].
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">profiler_end_scope</span>(profiler_scope_t scope);
</code></pre></div><p>Here we require the user to pass in an identifier for the scope. Note that from the profiler&rsquo;s
point of view, this isn&rsquo;t strictly necessary. The profiler could keep track of any scope-related
data on an internal stack. But by requiring the <code>scope</code> parameter, the user can&rsquo;t just call
<code>profiler_end_scope()</code> without calling <code>profiler_begin_scope()</code> first. And if the user calls:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">profiler_scope_t p <span style="color:#f92672">=</span> profiler_begin_scope(<span style="color:#e6db74">&#34;update&#34;</span>);
</code></pre></div><p>without a matching <code>profiler_end_scope()</code>, the compiler will give a warning about an unused
variable <code>p</code>.</p>
<p>Also, inside the profiler, we can add runtime checks (asserts) that trigger if the identifiers
passed to <code>profiler_begin_scope()</code> and <code>profiler_end_scope()</code> don&rsquo;t match up.</p>
<p>Finally, it&rsquo;s always good to give users the source code so that they can debug the problem
themselves. Even if you are building proprietary, commercial software, consider having some way of
sharing source with your advanced users. It will make your support easier and usually, the risks
are low (even when there are big public source code leaks it doesn&rsquo;t seem to adversely affect the
companies much).</p>
<h2 id="the-hard-to-reproduce-bug">The Hard-To-Reproduce Bug</h2>
<p>The standard debugging technique depends on us being able to reproduce the bug so that we can look
at it in the debugger. This fails right away if we can&rsquo;t reliably reproduce the bug.</p>
<p>When dealing with hard-to-reproduce bugs, the best first step is to try to increase the
reproduction rate. Sometimes you can do this by stress-testing the system. Do you suspect a bug
in the threading system? Maybe if you spawn 10,000 threads you can increase the likelihood that the
bug will appear. Does the bug sometimes happen when you open or close a window? Maybe if you make
your update function open and close 1,000 windows every frame, you will trigger the bug quicker.</p>
<p>If you are unable to get the reproduction rate high enough that you can debug the issue on your
local machine, a second tactic is to try to collect as much information as possible when the bug
does occur. This typically involves printing or logging some data and making sure that data gets
sent to you. Either manually, by people who are able to reproduce the bug, or automatically,
whenever the bug occurs.</p>
<p>Exactly what data you should send, depends a lot on what bug you are trying to fix. Basically, you
want to send enough information that you can figure out where your mental model of the code goes
wrong. This may involve several runs of back-and-forth where you add some debug printing, get error
logs back, realize this is still not enough to tell you what is going on, add more printing, etc.</p>
<p>A good starting point is to print stack traces. This will tell you in broad strokes <em>how the
computer got there</em>.</p>
<p>Another thing that can be useful is to add code to detect when the bug has happened. If you
need to log a lot of debugging information, you might not want to do it <em>all the time</em>. The logs
might become really large and the logging might slow down the execution of the program. To prevent
this, instead of logging to disk, you could just log to a fixed-size circular buffer in memory.
When you detect that the bug has occurred, you write out the content of this buffer. If the bug is
an access violation or some other kind of crash, you may need to use structured exception
handling to detect it.</p>
<p>Another tool to be aware of is remote debugging. Remote debugging is when you connect your
debugger to a process on a remote machine. I don&rsquo;t find remote debugging super useful in general,
because it can be hard to coordinate a debugging session with a remote location. But there are some
situations where it can be helpful, for example, to investigate what is happening on a production
server. Also, if you are developing for a non-desktop platform, such as a phone, an integrated
circuit, or a game console, all debugging sessions will be remote debugging sessions, since you
can&rsquo;t run a local debugger on that hardware.</p>
<h2 id="the-statistic">The Statistic</h2>
<p>When you start to have a huge number of users and those users generate a huge number of bugs, there
eventually comes a point where it becomes impractical to look at every single bug that occurs. What
do you do when you can&rsquo;t do a qualitative analysis of every single bug? You have to turn to
quantitative analysis â or statistics.</p>
<p>The goal of quantitative bug analysis is to:</p>
<ol>
<li>Automatically gather all bugs that occur and</li>
<li>find out which the most important ones are so that</li>
<li>you can focus your debugging efforts on them.</li>
</ol>
<p>Unfortunately, statistics can&rsquo;t fix the bugs for us, all it can do is to point us to the bugs that
are most important to fix.</p>
<p>It&rsquo;s important to set up automatic bug gathering because most end-users will not bother to
report bugs to you. Only people who <em>want to use your software and believe in your ability to
address its issues</em> will bother to make the effort of writing a bug report. It&rsquo;s important to keep
that in mind if you&rsquo;re ever tempted to be rude or dismissive when replying to a bug â the people
reporting bugs are doing you a favor.</p>
<p>Your automatic bug reporting system will probably be limited to a few <em>obvious</em> bugs, such as
crashes or memory leaks. For more subtle bugs, such as <em>&ldquo;the uniform in the first cutscene was not
available in that color until 1942&rdquo;</em> you will still have to rely on manual bug reports.</p>
<p>To find the most important bugs, you want to know:</p>
<ul>
<li>How many users are affected by the bug?</li>
<li>How often does the bug occur?</li>
</ul>
<p>To answer these questions, you first have to figure out what is meant by &ldquo;the bug&rdquo;. I.e., how do
you know when two of these automatic bug reports refer to the same bug? There is no surefire way. I
think the best approach is to group bugs by stack trace + error message. This is not guaranteed
to work. For example, it could be possible to reach the same faulty code through two different
paths in which case the stacks would be different even though itâs the same bug. And some bugs
(e.g., memory overwrites) tend to crash all over the place so they will generate a lot of noise in
the system. But I think it&rsquo;s the best we can do.</p>
<p>Once you have identified the important bugs, you need to fix them. This can be tricky because you
have no information about what the user did to cause the crash. Some high-level logging, similar to
the strategy for hard-to-reproduce bugs can be useful to get context. You can also have the bug
report include a memory dump so that you can inspect the state of the system when the crash
occurred.</p>
<h2 id="the-compiler-bug">The Compiler Bug</h2>
<p>A <em>compiler bug</em> is when you wrote your code correctly, but the compiler did not generate the right
machine code for it because of an error in the compiler.</p>
<p>Some people will confidently state that &ldquo;it&rsquo;s never a compiler error&rdquo;. This comes from bad
communication patterns where junior programmers get overzealous in blaming the compiler for their
own mistakes and jaded seniors reply &ldquo;It&rsquo;s not the compiler. It&rsquo;s never the compiler. Fix your
code.&rdquo; In this case, everyone would benefit from approaching the situation with a bit more humility
and empathy. We&rsquo;re all in this great big world together.</p>
<p>It&rsquo;s true that compiler bugs are rare. Much, much, much, much rarer than other bugs. So they should
never be your first go-to. Only suspect a compiler bug when you&rsquo;ve exhausted the other options.</p>
<p>But compiler bugs <em>do</em> happen. Compilers are software and as programmers, we know better than
anybody else that all software comes with bugs. I don&rsquo;t run into them often. Maybe once every six
months or so, hard to say exactly.</p>
<p>How do I know for sure that they were compiler bugs and not problems in my own code?</p>
<p>Well, sometimes the compiler actually <em>tells</em> you and that makes it pretty cut-and-dry. For
example, in Visual Studio, you will get the dreaded <code>fatal error C1001: Internal compiler error</code>.
That&rsquo;s a compiler bug if I ever saw one.</p>
<p>Unfortunately, not all compiler bugs give this clear-cut error message. Sometimes they just
generate the wrong code. How do you know in this case if you&rsquo;re dealing with a compiler error or
something else? Well, you can try:</p>
<ul>
<li>Compiling the code with a different compiler. (VS/llvm/gcc)</li>
<li>Changing the optimization settings.</li>
</ul>
<p>If that makes the bug go away, you <em>might</em> be dealing with a compiler bug. But it&rsquo;s still not 100 %
certain. For example, the bug could be caused by uninitialized stack variables and when you switch
compiler or change optimization settings, that data might just happen to end up being zeroed and
the bug goes away.</p>
<p>The only way to know for sure if you are dealing with a compiler bug is to look at the assembly
generated by the compiler. I think that in this day and age, learning how to <em>write</em> assembly is
usually not necessary for a systems programmer. But learning how to <em>read</em> assembly and especially
to <em>understand how C code is translated to assembly</em> can be very useful. If you can see that the
compiler is generating the wrong assembly, you can start to blame the compiler. A good learning
tool is the <a href="http://web.archive.org/web/20220502180503/https://godbolt.org/">Godbolt compiler explorer</a>.</p>
<p>But even with looking at the assembly, you still need to be careful. Modern C and C++ compilers
make use of <em>undefined behavior</em> in the language to optimize the code. I.e., they assume that
undefined behavior will never happen because if it did, the compiler is technically allowed to do
whatever it wants anyway. This can sometimes allow the compiler to remove whole swaths of code.</p>
<p>For example, this code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">foo</span> (<span style="color:#66d9ef">int</span> x) {
   <span style="color:#66d9ef">return</span> (x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&gt;</span> x;
}
</code></pre></div><p>When compiled with <code>-O2</code> compiles into just:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">foo(<span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
    mov     eax, <span style="color:#ae81ff">1</span>
    ret
</code></pre></div><p>I.e., the function always returns 1. This is because overflowing an <code>int</code> is an undefined behavior,
so the compiler assumes that it doesn&rsquo;t happen and if the <code>int</code> doesn&rsquo;t overflow, then <code>x + 1</code> is
always bigger than <code>x</code>.</p>
<p>In contrast, if you compile the same code <em>without</em> optimizations, the generated code will actually
perform the addition and the comparison. In this case <code>foo()</code> will return <code>0</code> when called with
<code>INT_MAX</code>.</p>
<p>You can discuss whether this use of undefined behavior for optimization is a good thing or not.
Personally, I&rsquo;m skeptical. I think doing a more literal translation of what the programmer wrote
helps with predictability, which is good for programmers, even if the code runs a little slower.</p>
<p>But, this is the world we live in, so you have to be aware of optimizations the compiler might make
around undefined behavior. Before you blame the compiler, even when looking at the assembly, you
have to make sure that there&rsquo;s no lurking undefined behavior that would make it legal for the
compiler to generate that code.</p>
<p>If you do run into an actual, real compiler bug, what do you do?</p>
<p>You can report the bug of course, but it will probably take a long time until any fixes make their
way back into the compiler you are using and, in the meantime, your code is not compiling. So
again, what can you do?</p>
<p>The only way I&rsquo;ve found to deal with compiler bugs is to slightly massage the code until it
starts working. Most compilers go through a lot of testing so when they fail it&rsquo;s usually not a
single thing that fails, but some complex interaction of inlining, optimizations, etc. In my
experience, it&rsquo;s hard to tell exactly what is triggering the failure. So I just move the code
around a little&hellip; change the order of some operations&hellip; write things a little differently. It can
be frustrating because I have no idea what will work, but eventually, I hit on something that does
and the code starts working again.</p>
<h2 id="did-i-forget-anything">Did I Forget Anything?</h2>
<p>Did I forget your favorite kind of bug or your favorite debugging technique? Let me know in the
comments!</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/authors/niklas" class="text-decoration-none">Niklas Gray</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220502180503/https://twitter.com/share?text=A%20Taxonomy%20of%20BugsÂ -Â Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fa-taxonomy-of-bugs%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220502180503/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fa-taxonomy-of-bugs%2f&amp;description=A%20Taxonomy%20of%20Bugs" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/release-2022-2/" class="text-decoration-none"><img src="../../images/release_22_2__dof.png" class="card-img-top" alt="The Machinery â February 2022 (version 2022.2)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/release-2022-2/">The Machinery â February 2022 (version 2022.2)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2022-02-28T00:00:00Z">
                      28 Feb 2022
                    </time>
                  </h6>
                  <p class="card-text"><p>Are you interested in meeting up with some of the Our Machinery team? Niklas, Tobias, and Karl will
be in San Francisco â¦</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/release-2022-2/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">12 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/release-2022-1/" class="text-decoration-none"><img src="../../images/release_22_1__thumbnails.png" class="card-img-top" alt="The Machinery â January 2022 (version 2022.1)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/release-2022-1/">The Machinery â January 2022 (version 2022.1)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2022-01-27T00:00:00Z">
                      27 Jan 2022
                    </time>
                  </h6>
                  <p class="card-text"><p>Happy 2022, Year of the Water Tiger! Here at Our Machinery, we have lots of interesting news
trickling out this year for â¦</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/release-2022-1/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">10 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/the-machinery-network-frontier-part-2/" class="text-decoration-none"><img src="../../images/netfront2__simulate_tabs.png" class="card-img-top" alt="The (Machinery) Network Frontier, Part 2"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/the-machinery-network-frontier-part-2/">The (Machinery) Network Frontier, Part 2</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2022-01-14T00:00:00Z">
                      14 Jan 2022
                    </time>
                  </h6>
                  <p class="card-text"><p>In this part of the series, weâll take a look at some high-level constructs that leverage the
basic concepts we saw in â¦</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/the-machinery-network-frontier-part-2/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">8 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/a-taxonomy-of-bugs/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20220502180503/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20220502180503/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20220502180503/https://ourmachinery.com/cdn-cgi/l/email-protection#52223b3c35123d27203f33313a3b3c37202b7c313d3f" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
         
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 18:05:03 May 02, 2022 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:51:13 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 154.222
  exclusion.robots: 0.173
  exclusion.robots.policy: 0.16
  cdx.remote: 0.105
  esindex: 0.012
  LoadShardBlock: 85.685 (3)
  PetaboxLoader3.datanode: 101.308 (4)
  CDXLines.iter: 32.549 (3)
  load_resource: 75.811
  PetaboxLoader3.resolve: 23.244
-->