











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="The implementation of the picking system in The Machinery."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/picking__alpha-mask.gif"/>
  
  <meta name="twitter:title" content="Borderland between Rendering and Editor — Part 2: Picking">
  <meta name="twitter:description" content="The implementation of the picking system in The Machinery."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Borderland between Rendering and Editor — Part 2: Picking · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/borderland-part-2-picking/"/>
  
  <meta property="og:image" content="../../images/picking__alpha-mask.gif"/>
  
  
  <meta property="og:description" content="The implementation of the picking system in The Machinery."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2020-05-26T00:00:00Z"/>
  

  <title>Borderland between Rendering and Editor — Part 2: Picking &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" media="screen, print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" media="screen, print"/>
  

  
  
  <link href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    ga('set', 'anonymizeIp', true);
    
  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="../../js/page.min.js?v=1.16"></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20220729080324/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20220729080324\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Tobias Persson",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20220729080324\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Borderland between Rendering and Editor — Part 2: Picking",
    "name": "Borderland between Rendering and Editor — Part 2: Picking",
    "wordCount":  1831 ,
    "timeRequired": "PT9M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/borderland-part-2-picking/",
    "datePublished": "2020-05-26T00:00Z",
    "dateModified": "2020-05-26T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20220729080324/https://ourmachinery.com/picking__alpha-mask.gif"
    },
    
    
    "description": "The implementation of the picking system in The Machinery."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
             
            
            
            
             
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/roadmap.html">Roadmap</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.github.io/themachinery-books/">Books</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/academic.html">Academic License</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20220729080324/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.github.io/themachinery-books/" aria-label="Opens Books" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Books</span></a>
        <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Borderland between Rendering and Editor — Part 2: Picking</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2020-05-26T00:00:00Z">
          May 26, 2020
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>In early March I wrote a <a href=" ../../post/borderland-between-rendering-and-editor-part-1/">post about the rendering of
grids</a> in our editor.
Before we dive into today’s topic, I wanted to show off a trivial addition to the grid rendering I’ve
added since the last post, rendering of an object local grid to guide moving of objects when
snapping is enabled:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Local grid to guide snapping." src="../../images/picking__local-grid.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4>Local grid to guide snapping.</h4>
    </figcaption>
  </figure>
<p>I think it turned out quite nice and it feels like a good example of how well the modularity aspects
of The Machinery work in practice — just query access to the <code>tm_grid_renderer_api</code> and add whatever
grid rendering your plugin might need.</p>
<p>Anyway, let’s move on. In today’s post, we’ll talk about mouse picking.</p>
<h2 id="picking--background">Picking — Background</h2>
<p>All types of 3D-editors tend to need some way to determine the object identity of whatever object
that happens to be under the mouse pointer when the user clicks inside a viewport. I’ll be referring
to this process as “picking”.</p>
<p>Picking, just like grid rendering, is one of those problems that typically are considered too
boring, or unimportant, for graphics programmers to even care about. Instead, it tends to end up in
the lap of some tools programmer to come up with a solution in one way or another. Usually, by doing
some form of ray cast from the position of the viewport camera through the mouse pointer coordinate
projected on the camera’s near plane.</p>
<p>The two most common approaches to implementing picking that I’ve seen are:</p>
<ol>
<li>Reuse an already existing system for doing ray casting, like physics.</li>
<li>Implement a special ray casting structure, only used for editor picking.</li>
</ol>
<p>The whole situation with distinct silos between rendering and tools folks, the prima donna attitude
among rendering programmers, and the two most common solutions to the problem are bad in so many
ways it makes me wanna cry.</p>
<p>Relying on e.g. the physics system will break as soon as you need to pick stuff that doesn’t have a
physics representation, and there are typically lots of objects rendered in a viewport that don’t
need one. A common user workaround is to start adding physics representations just for the sake of
making stuff pickable in the editor. Not ideal…</p>
<p>On the other hand, implementing a specific ray casting system only used for doing editor picking can
be a significant amount of work. Sure, the implementation doesn’t have to be the fastest in the
world since you will typically only be casting a single ray per frame (or less), but still, you’ll
definitely need some kind of acceleration structure (like a BVH-tree) as you definitely want to pick
against the actual rendered triangles and not some proxy. That structure will consume both memory
and take some time to cook, and as soon as you start dealing with somewhat more complicated scenes
with lots of objects (&gt;10K) you’ll probably need to add another level of acceleration structure.</p>
<p>Not to mention the fact that neither of these approaches will likely handle picking against
deformable objects (like skinned characters), or picking through alpha masked objects (e.g.
in-between the leaves on a tree), or handle purely voxel-based objects, or any kind of “Nanite”
-solution.</p>
<p>Clearly, this is not what you want. Even if it’s doable to implement a decent solution on the CPU,
what you really want is a GPU based picking solution. You want to know the identity of the pixel
under the mouse cursor, not the identity of some invisible proxy. The second you’ve worked with a
pixel-perfect solution that handles all kinds of geometry deformations and surface types, you will
never again be okay with anything that’s less accurate.</p>
<p>Ironically, implementing the foundations of a GPU-based picking solution is really straight forward,
much easier than any CPU-based picking solution you can think of. So let’s take a look at the
implementation we have in The Machinery.</p>
<h2 id="gpu-picking--implementation">GPU Picking — Implementation</h2>
<p>First of all, our solution relies on a few prerequisites, so let’s get them out of the way as I
won’t cover them in more detail in this post:</p>
<ul>
<li>
<p>First of all, we rely on our shader system being able to efficiently select a different shader
variation for all drawn objects in the viewport. We handle this using the “Systems”-concept
described in <a href=" ../../post/the-machinery-shader-system-part-3/">this post</a>.</p>
</li>
<li>
<p>Secondly, we rely on always running on hardware that supports binding Unordered Access Views
(UAVs) to the pixel shader.</p>
</li>
</ul>
<p>So the idea is very simple. When the user clicks inside a viewport, we activate a special shader
system called <code>picking_system</code>. That means that any shader that implements support for the
<code>picking_system</code> will activate a slightly different code path in the pixel (or compute) shader used
for rendering the object on screen.</p>
<p>The activated shader variation adds a call to <code>update_picking_buffer()</code> which is defined in the
<code>picking_system</code>. The actual picking buffer is something as silly as a 12 bytes buffer, bound as a
UAV, wrapping a simple struct:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> tm_gpu_picking_buffer_t
{
    <span style="color:#66d9ef">float</span> depth;
    uint64_t identity;
};
</code></pre></div><p>A naive implementation of <code>update_picking_buffer()</code> looks something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// `pos` should be SV_Position.xy (or comparable writing from a CS).
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// `identity` is a unique identifier of the rendered object. In TM this is
</span><span style="color:#75715e">// typically the ID of the entity issuing the GPU work.
</span><span style="color:#75715e">// 
</span><span style="color:#75715e">// `z` is the Z depth value of the shaded point.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// `opacity` is the opacity value of the currenly shaded pixel. 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_picking_buffers</span>(uint2 pos, uint2 identity, <span style="color:#66d9ef">float</span> z, <span style="color:#66d9ef">float</span> opacity) 
{
    <span style="color:#75715e">// If the opacity of the pixel is less than the &#34;opacity picking threshold&#34;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// -- return.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (opacity <span style="color:#f92672">&lt;</span> load_opacity_threshold())
        <span style="color:#66d9ef">return</span>;
    
    <span style="color:#75715e">// If this pixel is not under the mouse cursor -- return.
</span><span style="color:#75715e"></span>    uint2 cursor_pos <span style="color:#f92672">=</span> load_cursor_pos();
    <span style="color:#66d9ef">if</span> (pos.x <span style="color:#f92672">!=</span> cursor_pos.x <span style="color:#f92672">||</span> pos.y <span style="color:#f92672">!=</span> cursor_pos.y)
        <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// Compare pixel z against the currently stored z-value in the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// picking_buffer. If it&#39;s greater or equal (behind) -- return. 
</span><span style="color:#75715e"></span>    uint d <span style="color:#f92672">=</span> asuint(z);
    <span style="color:#66d9ef">if</span> (d <span style="color:#f92672">&gt;=</span> picking_buffer.Load(<span style="color:#ae81ff">0</span>))
        <span style="color:#66d9ef">return</span>;
    
    <span style="color:#75715e">// Update picking buffer. 
</span><span style="color:#75715e"></span>    picking_buffer.Store3(<span style="color:#ae81ff">0</span>, uint3(d, identity));
}
</code></pre></div><p>While this naive implementation will produce the correct picking result most of the time, it will
occasionally fail and return a picking result that is behind the closest surface. This is because we
need to protect against concurrent access to the <code>picking_buffer</code>.</p>
<p>We can use atomics together with exploiting the sign bit of <code>d</code> to implement a spinlock mechanism
that prevents concurrent updates to the <code>picking_buffer</code> from happening. The implementation is a bit
hairy, but looks something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">uint d <span style="color:#f92672">=</span> asuint(z);
uint current_d_or_locked <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">do</span> {
    <span style="color:#75715e">// `z` is behind the stored z value, return immediately.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (d <span style="color:#f92672">&gt;=</span> picking_buffer.Load(<span style="color:#ae81ff">0</span>))
            <span style="color:#66d9ef">return</span>;
    
    <span style="color:#75715e">// Perform an atomic min. `current_d_or_locked` holds the currently stored
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// value.
</span><span style="color:#75715e"></span>    picking_buffer.InterlockedMin(<span style="color:#ae81ff">0</span>, d, current_d_or_locked);
    <span style="color:#75715e">// We rely on using the sign bit to indicate if the picking buffer is
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// currently locked. This means that this branch will only be entered if the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// buffer is unlocked AND `d` is the less than the currently stored `d`. 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (d <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">int</span>)current_d_or_locked) {
            uint last_d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#75715e">// Attempt to acquire write lock by setting the sign bit.
</span><span style="color:#75715e"></span>            picking_buffer.InterlockedCompareExchange(<span style="color:#ae81ff">0</span>, d, asuint(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">int</span>)d), 
                last_d);
            <span style="color:#75715e">// This branch will only be taken if taking the write lock succeded.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (last_d <span style="color:#f92672">==</span> d) {
                    <span style="color:#75715e">// Update the object identity.
</span><span style="color:#75715e"></span>                    picking_buffer.Store2(<span style="color:#ae81ff">4</span>, identity);
                    uint dummy;
                    <span style="color:#75715e">// Release write lock. 
</span><span style="color:#75715e"></span>                    picking_buffer.InterlockedExchange(<span style="color:#ae81ff">0</span>, d, dummy);
            }
    }
<span style="color:#75715e">// Spin until write lock has been released.
</span><span style="color:#75715e"></span>} <span style="color:#66d9ef">while</span>((<span style="color:#66d9ef">int</span>)current_d_or_locked <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><p>With the spinlock-update in place, you should always be getting the closest surface in the picking
buffer.</p>
<p>So that’s it on the shader side of things, now let’s move over to the CPU side and take a look at
the C-API we have in place for scheduling and reading back the result of the <code>picking_buffer</code> from
the GPU to the CPU. It’s called <code>tm_gpu_picking_api</code> and looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> tm_gpu_picking_api
{
    <span style="color:#66d9ef">struct</span> tm_gpu_picking_o <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>create)(<span style="color:#66d9ef">struct</span> tm_allocator_i <span style="color:#f92672">*</span>allocator, 
        <span style="color:#66d9ef">struct</span> tm_renderer_resource_command_buffer_o <span style="color:#f92672">*</span>res_buf, 
        <span style="color:#66d9ef">struct</span> tm_shader_system_o <span style="color:#f92672">*</span>picking_system, 
        <span style="color:#66d9ef">struct</span> tm_shader_o <span style="color:#f92672">*</span>clear_picking_buffer_shader);

    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>destroy)(<span style="color:#66d9ef">struct</span> tm_gpu_picking_o <span style="color:#f92672">*</span>inst, 
        <span style="color:#66d9ef">struct</span> tm_renderer_resource_command_buffer_o <span style="color:#f92672">*</span>res_buf);

    <span style="color:#66d9ef">bool</span> (<span style="color:#f92672">*</span>update_cpu)(<span style="color:#66d9ef">struct</span> tm_gpu_picking_o <span style="color:#f92672">*</span>inst, 
        <span style="color:#66d9ef">struct</span> tm_renderer_backend_i <span style="color:#f92672">*</span>rb, <span style="color:#66d9ef">bool</span> activate_system, 
        <span style="color:#66d9ef">const</span> tm_vec2_t cursor_position, <span style="color:#66d9ef">float</span> opacity_threshold,
        uint64_t <span style="color:#f92672">*</span>result);

    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>update_gpu)(<span style="color:#66d9ef">struct</span> tm_gpu_picking_o <span style="color:#f92672">*</span>inst, 
        <span style="color:#66d9ef">struct</span> tm_shader_system_context_o <span style="color:#f92672">*</span>context,
        <span style="color:#66d9ef">struct</span> tm_renderer_resource_command_buffer_o <span style="color:#f92672">*</span>res_buf, 
        <span style="color:#66d9ef">struct</span> tm_renderer_command_buffer_o <span style="color:#f92672">*</span>cmd_buf,
        uint32_t device_affinity_mask);
};
</code></pre></div><p><code>create()</code> and <code>destroy()</code> are simply responsible for creating and destroying a picking object. Each
viewport that supports picking has its own <code>tm_gpu_picking_o</code>. Internally, <code>tm_gpu_picking_o</code> owns
the <code>picking_buffer</code> and some state.</p>
<p><code>update_cpu()</code> is typically called every frame somewhere inside the UI/editor code and does two
things:</p>
<ol>
<li>
<p>Checks if there’s a new read-back result available for the <code>picking_buffer</code>. If so the <code>identity</code>
part of the <code>picking_buffer</code> is returned in <code>result</code> and the function returns <em>true</em>. Object
selection tracking in The Machinery is based on the entity ID so we can simply pass the entity ID
as part of a constant buffer to all draw and dispatch calls which means that the returned value
in <code>result</code>  can be used directly without any additional lookup.</p>
</li>
<li>
<p>If the user clicked the mouse button somewhere inside a viewport, <em>true</em> should be passed to
<code>activate_system</code> together with the cursor position and an arbitrary opacity threshold. This
prepares the state that will be passed to the <code>picking_system</code> through a constant buffer and
queues it for activation. The opacity threshold controls at which surface opacity value a pixel
should be clicked-through (i.e., rejected). I have plans exposing control over the opacity
threshold in the editor but haven’t got around to it, right now we only pass 0.5 which feels like
a decent default value. Any pixel with opacity less than 0.5 will be clicked through.</p>
</li>
</ol>
<p><code>update_gpu()</code> is called whenever we’re about to render a viewport. It does the following:</p>
<ol>
<li>
<p>If the <code>picking_system</code> wasn’t activated when the last call to <code>update_cpu()</code> was made, it just
returns immediately.</p>
</li>
<li>
<p>Queues a compute dispatch call to clear the <code>picking_buffer</code>, scheduled to execute before any
other rendering happens in the viewport.</p>
</li>
<li>
<p>Updates the constant buffer associated with the <code>picking_system</code> with the mouse cursor position
and opacity threshold passed to <code>update_cpu()</code>.</p>
</li>
<li>
<p>Queues an asynchronous read-back operation of the <code>picking_buffer</code> from the GPU to CPU, scheduled
to run after all rendering has finished in the viewport.</p>
</li>
</ol>
<p>As we don’t want to stall the GPU with the read-back of the <code>picking_buffer</code>, it can take a few
frames until the result is available and <em>true</em> is returned from <code>update_cpu()</code>. In practice though,
this delay hasn’t been noticeable from a user’s perspective.</p>
<p>Here’s a gif-animation showing the picking system in action:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Pixel-perfect picking through alpha masked leafs." src="../../images/picking__alpha-mask.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4>Pixel-perfect picking through alpha masked leafs.</h4>
    </figcaption>
  </figure>
<h2 id="wrap-up">Wrap up</h2>
<p>With a GPU-based picking solution you’ll never again have to struggle with complicated picking code
on the CPU-side, anything that’s visualized on screen can be picked as long as the shader implements
the <code>picking_system</code> which isn’t more than a couple of lines of code.</p>
<p>Also note that while the code examples from above only cover pixel-perfect selection, there’s
nothing preventing you from extending it to do more of a fuzzy selection, just calculating the
distance between the cursor and the current pixel and accept a distance value less than <em>n</em> pixels.
This can be useful when dealing with selection of editor gizmos and similar.</p>
<p>Until next time…</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/authors/tobias" class="text-decoration-none">Tobias Persson</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220729080324/https://twitter.com/share?text=Borderland%20between%20Rendering%20and%20Editor%20%e2%80%94%20Part%202%3a%20Picking - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fborderland-part-2-picking%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20220729080324/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fborderland-part-2-picking%2f&amp;description=Borderland%20between%20Rendering%20and%20Editor%20%e2%80%94%20Part%202%3a%20Picking" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/wasabi-part-4-working-from-home/">WaSaBi Part 4: Working From Home</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-05-07T00:00:00Z">
                      7 May 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>I was going to save this topic for later on down the road, but it seems apropos in our current
situation.</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/wasabi-part-4-working-from-home/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/recording-statistics/" class="text-decoration-none"><img src="../../images/recstat__graph.png" class="card-img-top" alt="Recording Statistics — An Exercise in Minimalism"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/recording-statistics/">Recording Statistics — An Exercise in Minimalism</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-04-27T00:00:00Z">
                      27 Apr 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>I recently added a <em>Statistics</em> view to The Machinery. It can be used to display various real-time
statistics from the …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/recording-statistics/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">11 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/gpu-simulation/" class="text-decoration-none"><img src="../../images/gpu_sim__particle_effect.gif" class="card-img-top" alt="GPU Simulation"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/gpu-simulation/">GPU Simulation</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-04-14T00:00:00Z">
                      14 Apr 2020
                    </time>
                  </h6>
                  <p class="card-text">I know I said I was going to do a multi-part series on the “Borderland between Rendering and Editor” and I’m still …</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/gpu-simulation/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">10 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/borderland-part-2-picking/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20220729080324/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20220729080324/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20220729080324/https://ourmachinery.com/cdn-cgi/l/email-protection#bacad3d4ddfad5cfc8d7dbd9d2d3d4dfc8c394d9d5d7" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
         
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 08:03:24 Jul 29, 2022 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:52:19 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 123.52
  exclusion.robots: 0.084
  exclusion.robots.policy: 0.077
  RedisCDXSource: 1.07
  esindex: 0.009
  LoadShardBlock: 105.723 (3)
  PetaboxLoader3.datanode: 121.062 (4)
  CDXLines.iter: 13.553 (3)
  load_resource: 83.438
  PetaboxLoader3.resolve: 32.856
-->