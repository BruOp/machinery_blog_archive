











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="How we implemented statistics recording in The Machinery."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/recstat__graph.png"/>
  
  <meta name="twitter:title" content="Recording Statistics — An Exercise in Minimalism">
  <meta name="twitter:description" content="How we implemented statistics recording in The Machinery."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Recording Statistics — An Exercise in Minimalism · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/recording-statistics/"/>
  
  <meta property="og:image" content="../../images/recstat__graph.png"/>
  
  
  <meta property="og:description" content="How we implemented statistics recording in The Machinery."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2020-04-27T00:00:00Z"/>
  

  <title>Recording Statistics — An Exercise in Minimalism &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" integrity="" print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" integrity="" print"/>
  

  
  
  <link href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js" integrity=""></script>
  <script type="text/javascript" src="../../js/page.min.js" integrity=""></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210804195350/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210804195350\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Niklas Gray",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210804195350\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Recording Statistics — An Exercise in Minimalism",
    "name": "Recording Statistics — An Exercise in Minimalism",
    "wordCount":  2265 ,
    "timeRequired": "PT11M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/recording-statistics/",
    "datePublished": "2020-04-27T00:00Z",
    "dateModified": "2020-04-27T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20210804195350/https://ourmachinery.com/recstat__graph.png"
    },
    
    
    "description": "How we implemented statistics recording in The Machinery."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                About
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/product.html" aria-label="Link The Machinery">The Machinery</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/about.html" aria-label="Link About Us">About Us</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/press.html" aria-label="Link Press Kit">Press Kit</a>
                </li>
                
              </ul>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804195350/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804195350/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Recording Statistics — An Exercise in Minimalism</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2020-04-27T00:00:00Z">
          Apr 27, 2020
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>I recently added a <em>Statistics</em> view to The Machinery. It can be used to display various real-time
statistics from the engine:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Frame time plotted." src="../../images/recstat__graph.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Frame time plotted.</h4>
    </figcaption>
  </figure>
<p>In addition to drawing graphs, data can also be presented in tabular form, for more precise
inspection:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="Frame time shown as table." src="../../images/recstat__table.png"/>
    <figcaption class="figure-caption fs-5">
        <h4>Frame time shown as table.</h4>
    </figcaption>
  </figure>
<p>Graphs are useful because they expose a lot of information in a way that it can be quickly processed
by the human visual cortex. Things like glitches, anomalies and bad patterns stand out in a way they
don’t if you are just looking at numbers in a profiler:</p>
<ul>
<li>
<p>If you see occasional spikes in the frame rate but have a hard time pinpointing where they are
coming from, you can plot the time spent in some of the major engine systems and see if one of
them has spikes that coincide with the frame rate spikes. If it does, you have found the main
source of the frame hitches.</p>
</li>
<li>
<p>Plotting memory usage over time is a good way of finding leaks and other problematic patterns.
Now, we already have memory leak detection in the engine, but it only detects memory that <em>never
gets freed</em>. There are other kinds of “leaks” that can also cause problems. For example, you might
have an array that just grows and grows, because elements keep getting added to it without being
removed. This is not a <em>true</em> memory leak, because we are still keeping track of all allocations
and the memory eventually gets freed when the array is destroyed — perhaps at the end of the
level. But memory use still grows unbounded in this situation, causing the application to
eventually run out. This type of “leak” can happen even in garbage-collected languages.</p>
<p>In the statistics view, this shows up as a typical pattern of memory use that keeps rising while
a level is being played and then drops sharply when the level is restarted. Finding the root
cause can still be tricky — these kind of “leaks” are harder to fix than the “real” ones — but
looking at the statistics can put you on the right track and let you narrow it down to a
specific system.</p>
</li>
<li>
<p>Another example — suppose you are noticing an unusually high number of draw calls in a certain
part of a level. By keeping the draw call statistics on screen as you pan around with the camera,
you can check if you notice any sudden jumps as certain objects enter and leave the view frustum.
In this way, you can quickly pinpoint the problematic object.</p>
</li>
</ul>
<p>In my case, I wanted to use the <em>Statistics</em> view to investigate a weird “jerkiness” in the camera
that I was sometimes seeing. As I was panning the camera smoothly, it kept jumping back, almost as
if time was going backward. Weirdly, I couldn’t capture the phenomenon with any screen capturing
tools, only by filming the screen with my phone.</p>
<p>So I wanted to plot the frame rate and camera position over time to see if I could spot any patterns
that could explain the behavior.</p>
<p>(Spoiler: I didn’t. Both the frame time and the camera position moved smoothly. The jerkiness seems
to have something to do with running on a secondary monitor — it always runs smoothly on my main
screen. This, together with the fact that I can’t screen capture the issue, seem to indicate that
frames somehow get “reordered” as they are sent to the secondary monitor. Now, that sounds super
weird to me and I’m not sure how that is even possible. Might be a topic for a future blog post if
we can figure it out.)</p>
<p>But anyway, that was the impetus for creating this system. And even though it couldn’t resolve this
particular issue, it’s still a very useful thing to have in the engine. In this post, I’ll talk a
little about how it’s implemented.</p>
<p>Drawing the graphs is pretty straightforward, so let’s focus on the more interesting problem: how do
we collect the data that we draw?</p>
<p>There are two main requirements on the data collection:</p>
<ul>
<li>
<p>First, it must be extensible. <em>The Machinery</em> is plugin-based and each plugin should be able to
add its own counters to the system. In addition, there are lots of game-specific data that are
interesting to track too, such as the number of enemies, A* searches, etc.</p>
</li>
<li>
<p>Second, the system must be fast enough that you can add statistics everywhere, and don’t worry
about leaving it in the code. Having the statistics always available lets you do exploratory
investigations that you might not bother with if you have to explicitly insert and remove stats
collection every time you want to check something. In particular, I find it very useful to have
statistics counters for all profiling scopes, so we can examine them for hitches. This tends to be
a lot of data, so the system needs to be efficient.</p>
</li>
</ul>
<p>A straightforward API for data collection might look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">add_to_frame_counter(<span style="color:#e6db74">&#34;renderer/primitive-count&#34;</span>, n);
</code></pre></div><p>Here we use a string to identify the data counter. (We need some human-readable identification so
that we can browse for the counter in the UI.) The function call simply adds <code>n</code> to the current
frame’s value for the counter.</p>
<p>Note that I’ve chosen to accumulate all the data for each counter over the frame. This is not a 100 % self-evident choice. Some sources might get multiple data points per frame or less than a data point per frame. For example, if you are looking at the size of inbound network packages, you might have a lot of frames where you get no package at all and some frames where you get multiple packages. Instead of tracking the package size per frame, we could treat each incoming package as its own data point.</p>
<p>Here’s what the data might look like using the two different methods.</p>
<p><em>Creating a data point for each incoming package:</em></p>
<style>
    table.grid {border: 1pt solid #999;}
    table.grid td {border: 1pt solid #999; text-align: right;}
    table.grid th {border: 1pt solid #999;}

</style>
<table class="grid">
<tr><th> When (frame #) </th><td> 3.5 </td><td> 6.1  </td><td> 6.3 </td><td> 9.2 </td></tr>
<tr><th> Packet size    </th><td> 782 </td><td> 1003 </td><td> 450 </td><td> 510 </td></tr>
</table>
<p><em>Accumulating the data per frame:</em></p>
<table class="grid">
    <tr><th> Frame #     </th><td> 0 </td><td> 1 </td><td> 2 </td><td> 3   </td><td> 4 </td><td> 5 </td><td> 6    </td><td> 7 </td><td> 8 </td><td> 9   </td><td> 10 </td></tr>
    <tr><th> Packet size </th><td> 0 </td><td> 0 </td><td> 0 </td><td> 782 </td><td> 0 </td><td> 0 </td><td> 1453 </td><td> 0 </td><td> 0 </td><td> 510 </td><td> 0  </td></tr>
</table>
<p>There might be some cases where it is useful to have the data disconnected from the frame rate as in
the first table, but I think in most situations, the accumulated view in the second table is enough
to tell you what is going on. It is also really valuable to have all the data sources in the same
format — for instance, it means we can readily display them in the same table.</p>
<p>Also, if we accumulating the data per frame, we can automatically use the current frame time as the
“clock” for all our data. If we disconnect the data points from the frames, we have to sample the
clock each time we add a data point — adding more overhead.</p>
<p>For all these reasons, I like using frame-accumulated counters.</p>
<p>The implementation for our API might look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> source_t {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">double</span> values[MAX_FRAMES];
};

<span style="color:#66d9ef">struct</span> stats_t {
    chash32_t name_to_idx;
    <span style="color:#66d9ef">struct</span> source_t <span style="color:#f92672">*</span>sources;
    uint64_t current_frame;
} stats;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_to_frame_counter</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">double</span> value)
{
    <span style="color:#66d9ef">const</span> uint64_t key <span style="color:#f92672">=</span> murmurhash(name);
    uint32_t idx <span style="color:#f92672">=</span> chash32_get(<span style="color:#f92672">&amp;</span>stats<span style="color:#f92672">-&gt;</span>name_to_idx, key);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>idx) {
        source_t source <span style="color:#f92672">=</span> {.name <span style="color:#f92672">=</span> name};
        carray_push(stats<span style="color:#f92672">-&gt;</span>sources, source);
        idx <span style="color:#f92672">=</span> carray_size(stats<span style="color:#f92672">-&gt;</span>sources) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
        chash32_add(<span style="color:#f92672">&amp;</span>stats<span style="color:#f92672">-&gt;</span>name_to_idx, key, idx);
    }
    source_t <span style="color:#f92672">*</span>source <span style="color:#f92672">=</span> stats<span style="color:#f92672">-&gt;</span>sources <span style="color:#f92672">+</span> idx;
    source<span style="color:#f92672">-&gt;</span>values[stats<span style="color:#f92672">-&gt;</span>current_frame <span style="color:#f92672">%</span> MAX_FRAMES] <span style="color:#f92672">+=</span> value;
}
</code></pre></div><p>I use a <code>double</code> for the values so I can store both large integers and floats with good precision.
You could use different types for different counters. This would buy you a little bit of performance
at the price of added complexity. Again, I find it nice and simple to just have everything in the
same format.</p>
<p>The system keeps track of the last <code>MAX_FRAMES</code> values for each counter, storing them in a ring
buffer <code>values</code> and uses a hash table to look up the counter based on its name.</p>
<p>Straightforward, but also pretty expensive. Every time we want to increment a counter, we have to
hash the string and make a lookup in the hash table. Also, since <code>stats</code> is a global variable and we
want to be able to record stats on multiple threads, we should probably put this whole thing in a
critical section too, making things even slower.</p>
<p>Let’s try to improve this.</p>
<p>The first thing we can do is cache the lookup. Looking up the same string will always result in the
same value, so there is no reason for us to do the lookup every time — we can just store the result.
To take advantage of this, we must make the caller keep track of the index. The API for the caller
thus changes to something like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> uint32_t primitive_counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>primitive_counter)
    primitive_counter <span style="color:#f92672">=</span> get_counter(<span style="color:#e6db74">&#34;renderer/primitive-count&#34;</span>);

add_to_frame_counter(primitive_counter, n);
</code></pre></div><p>Since the result of the lookup is permanent we can store it in a static variable. We could also
store it in a struct or a global variable when the calling system is initialized to avoid the
<code>if (!primitive_counter)</code> test.</p>
<p>The implementation now looks something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">uint32_t <span style="color:#a6e22e">get_counter</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name)
{
    <span style="color:#66d9ef">const</span> uint64_t key <span style="color:#f92672">=</span> murmurhash(name);
    uint32_t idx <span style="color:#f92672">=</span> chash32_get(<span style="color:#f92672">&amp;</span>stats<span style="color:#f92672">-&gt;</span>name_to_idx, key);
    <span style="color:#66d9ef">if</span> (idx)
        <span style="color:#66d9ef">return</span> idx;
    <span style="color:#66d9ef">struct</span> source_t source <span style="color:#f92672">=</span> {.name <span style="color:#f92672">=</span> name};
    carray_push(stats<span style="color:#f92672">-&gt;</span>sources, source);
    idx <span style="color:#f92672">=</span> carray_size(stats<span style="color:#f92672">-&gt;</span>sources) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
    chash32_add(<span style="color:#f92672">&amp;</span>stats<span style="color:#f92672">-&gt;</span>name_to_idx, key, idx);
    <span style="color:#66d9ef">return</span> idx;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_to_frame_counter</span>(uint32_t idx, <span style="color:#66d9ef">double</span> value)
{
    <span style="color:#66d9ef">struct</span> source_t <span style="color:#f92672">*</span>source <span style="color:#f92672">=</span> stats<span style="color:#f92672">-&gt;</span>sources <span style="color:#f92672">+</span> idx;
    source<span style="color:#f92672">-&gt;</span>values[stats<span style="color:#f92672">-&gt;</span>current_frame <span style="color:#f92672">%</span> MAX_FRAMES] <span style="color:#f92672">+=</span> value;
}
</code></pre></div><p>A big improvement &ndash; the hot code path <code>add_to_frame_counter()</code> is now significantly shorter.</p>
<p>One problem that still exists is that all these counters might be using a significant amount of
memory. Each counter is allocating <code>MAX_FRAMES * 8</code> bytes of memory for its values. If we have
thousands of counters (which we can easily have with a counter for each profiler scope) and want to
save a few thousand frames of history, so we can see how the data is trending, this adds up to
multiple megabytes of data.</p>
<p>One way of getting around that is to only allocate the <code>values</code>  array for the counters that the
user is actively looking at in the <em>Statistics</em> view. This should be a small fraction of the total
number. When we record, we check if the array has been allocated:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_to_frame_counter</span>(uint32_t idx, <span style="color:#66d9ef">double</span> value)
{
    <span style="color:#66d9ef">struct</span> source_t <span style="color:#f92672">*</span>source <span style="color:#f92672">=</span> stats<span style="color:#f92672">-&gt;</span>sources <span style="color:#f92672">+</span> idx;
    <span style="color:#66d9ef">if</span> (source<span style="color:#f92672">-&gt;</span>values)
        source<span style="color:#f92672">-&gt;</span>values[stats<span style="color:#f92672">-&gt;</span>current_frame <span style="color:#f92672">%</span> MAX_FRAMES] <span style="color:#f92672">+=</span> value;
}
</code></pre></div><p>Overall this looks pretty decent, but can we do better? That if-statement is a possible branch
misprediction. We also have the overhead of the function call itself. And, we might need a critical
section to protect against <code>stats-&gt;sources</code> growing and being reallocated by a different thread.</p>
<p>We could inline the <code>add_to_frame_counter()</code>, but that would require us to put both <code>source_t</code> and
<code>stats_t</code> in the header file, leaking a lot of implementation details. At Our Machinery, we like to
keep the header files minimalistic and only expose public APIs. Both to keep the compile times down
and to reduce the mental load of anyone reading the code. So what else can we do?</p>
<p>Let’s take a step back and ask ourselves what is the minimum thing that we need to perform the
<code>add_to_frame_counter()</code> operation. We don’t <em>need</em> to know the index of this particular counter in
the statistics system, all we <em>really</em> need is a place where we can write the counter’s new value.
So why not have the <code>get_counter()</code> function return exactly that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> source_t {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">double</span> <span style="color:#f92672">*</span>values;
    <span style="color:#66d9ef">double</span> frame_value;
};

<span style="color:#66d9ef">double</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_counter</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name)
{
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>stats<span style="color:#f92672">-&gt;</span>sources[idx].frame_value;
}
</code></pre></div><p>Here, <code>get_counter()</code> just returns a pointer to an accumulator variable <code>frame_value</code>. We use that
value to accumulate the counter over the frame and at the end of the frame, we add it to the
<code>values</code> array.</p>
<p>Here is how you would use it in the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">double</span> <span style="color:#f92672">*</span>primitive_counter;
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>primitive_counter)
    primitive_counter <span style="color:#f92672">=</span> get_counter(<span style="color:#e6db74">&#34;renderer/primitive-count&#34;</span>);

<span style="color:#f92672">*</span>primitive_counter <span style="color:#f92672">+=</span> n;
</code></pre></div><p>Again, we could perform the initialization of <code>primitive_counter</code> at the initialization of this
module, so we don’t have to check <code>if (!primitive_counter)</code> every frame.</p>
<p>Now there are no function calls, no branch statements, no critical sections, etc — the only thing we
do is an assignment through a pointer.</p>
<p>Note that for this to work, the pointer returned by <code>get_double()</code> must be permanent. I.e., once the
<code>source_t</code> structure has been created, it cannot move in memory, since that would invalidate all the
<code>get_double()</code> pointers that have already been returned and cached.</p>
<p>There are several different ways to achieve this:</p>
<ul>
<li>
<p>You could use a fixed-sized array if you are OK with setting an upper limit on the number of
sources.</p>
</li>
<li>
<p>You could use a VM allocated array as <a href=" ../../post/data-structures-part-1-bulk-data/">described in a previous
post</a>.</p>
</li>
<li>
<p>Or, you could allocate the sources using a sequence of fixed-sized blocks, instead of in a single
big array.</p>
</li>
</ul>
<p>Since we never delete counters we don’t have to keep track of a freelist (as you usually do when you
have an array where you want fixed element pointers).</p>
<p>We copy the current <code>frame_value</code> into the <code>values</code> array when we register a new frame in the
statistics system (same place where we increase the <code>current_frame</code> counter):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">push_frame</span>()
{
    <span style="color:#66d9ef">const</span> uint64_t i <span style="color:#f92672">=</span> stats<span style="color:#f92672">-&gt;</span>current_frame <span style="color:#f92672">%</span> MAX_FRAMES;
    <span style="color:#f92672">++</span>stats<span style="color:#f92672">-&gt;</span>current_frame;
    <span style="color:#66d9ef">for</span> (source_t <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> stats<span style="color:#f92672">-&gt;</span>sources; s <span style="color:#f92672">!=</span> carray_end(stats<span style="color:#f92672">-&gt;</span>sources); <span style="color:#f92672">++</span>s) {
        <span style="color:#66d9ef">if</span> (s<span style="color:#f92672">-&gt;</span>values)
            s<span style="color:#f92672">-&gt;</span>values[i] <span style="color:#f92672">=</span> s<span style="color:#f92672">-&gt;</span>frame_value;
        s<span style="color:#f92672">-&gt;</span>frame_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
}
</code></pre></div><p>With this, we have a very simple and fast way of recording arbitrary statistics data for later
rendering.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/authors/niklas" class="text-decoration-none">Niklas Gray</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804195350/https://twitter.com/share?text=Recording%20Statistics%20%e2%80%94%20An%20Exercise%20in%20Minimalism - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2frecording-statistics%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804195350/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2frecording-statistics%2f&amp;description=Recording%20Statistics%20%e2%80%94%20An%20Exercise%20in%20Minimalism" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta-2020-4/" class="text-decoration-none"><img src="../../images/beta_20_4__viewport_hud.png" class="card-img-top" alt="The Machinery Beta — April 2020 (version 2020.4)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2020-4/">The Machinery Beta — April 2020 (version 2020.4)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-04-10T00:00:00Z">
                      10 Apr 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>Welcome to the second release of The Machinery Beta — April 2020! We have a number of new features
and updates in this …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2020-4/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">10 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/wasabi-part-3-accessibility/">WaSaBi Part 3: Accessibility</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-04-03T00:00:00Z">
                      3 Apr 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>We talk a lot in our blogs and podcast about inclusivity. It’s something I really, really want us to
achieve as a …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/wasabi-part-3-accessibility/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">3 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta/" class="text-decoration-none"><img src="../../images/beta__editor.png" class="card-img-top" alt="The Machinery Beta — March 2020 (version 2020.3)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta/">The Machinery Beta — March 2020 (version 2020.3)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-03-18T00:00:00Z">
                      18 Mar 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>Welcome to the very first beta release of Our Machinery. Since these are our first official release
notes they will …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">13 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/recording-statistics/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210804195350/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804195350/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/cdn-cgi/l/email-protection#3f4f5651587f504a4d525e5c5756515a4d46115c5052" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210804195350/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 19:53:50 Aug 04, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:52:21 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 67.358
  exclusion.robots: 0.095
  exclusion.robots.policy: 0.087
  RedisCDXSource: 0.533
  esindex: 0.009
  LoadShardBlock: 45.576 (3)
  PetaboxLoader3.datanode: 45.404 (4)
  CDXLines.iter: 18.683 (3)
  load_resource: 47.21
  PetaboxLoader3.resolve: 25.888
-->