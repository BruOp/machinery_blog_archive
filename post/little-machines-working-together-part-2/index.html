











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content=""/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/machinery-logo.png"/>
  
  <meta name="twitter:title" content="Little Machines Working Together (Part 2)">
  <meta name="twitter:description" content=""/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Little Machines Working Together (Part 2) Â· Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/little-machines-working-together-part-2/"/>
  
  <meta property="og:image" content="../../images/machinery-logo.png"/>
  
  
  <meta property="og:description" content=""/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2017-06-05T00:00:00Z"/>
  

  <title>Little Machines Working Together (Part 2) &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" media="screen, print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" media="screen, print"/>
  

  
  
  <link href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="../../js/page.min.js?v=1.16"></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210830070717/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210830070717\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Niklas Gray",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210830070717\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Little Machines Working Together (Part 2)",
    "name": "Little Machines Working Together (Part 2)",
    "wordCount":  2183 ,
    "timeRequired": "PT11M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/little-machines-working-together-part-2/",
    "datePublished": "2017-06-05T00:00Z",
    "dateModified": "2017-06-05T00:00Z",
    
    
    "description": ""
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/academic.html" aria-label="Link Academic License" target="_blank">Academic License</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/roadmap.html">Roadmap</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/academic.html">Academic License</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210830070717/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Little Machines Working Together (Part 2)</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2017-06-05T00:00:00Z">
          Jun 5, 2017
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>In the <a href=" ../../post/little-machines-working-together-part-1/">previous post</a> in this series I talked about our API registry that lets parts of our code register interfaces that other parts of the code can query for and call. The main advantage of doing this through a dynamic registry instead of through static linking is that the different modules can be written completely independent of one another, live in separate DLLs, and be loaded and unloaded dynamically. In this part Iâll show how we create a plugin from these parts.</p>
<h2 id="classes-in-c">Classes in C</h2>
<p>In addition to APIs our headers also contain definitions of <em>objects</em> with <em>state</em>. For example we define an allocator as (simplified here for brevity):</p>
<pre><code>struct tm_allocator_i {
    struct tm_allocator_o *inst;
    void *(*realloc)(struct tm_allocator_o *inst, void *ptr, uint64_t size);
};
</code></pre>
<p>Here, <code>struct tm_allocator_o *inst</code> is an opaque pointer to the state data of an allocator. In the implementation of the allocator we cast the data to whatever structure the allocator uses internally.</p>
<p>The <code>tm_allocator_i</code> struct contains everything a client needs in order to use the allocator â the state and the functions that operate on that state, bundled up in the same struct. Calling the allocator through its API looks something like:</p>
<pre><code>void *my_buffer = allocator-&gt;realloc(allocator-&gt;inst, NULL, 1024*1024);
</code></pre>
<p>Note that different allocator implementations can be completely unrelated. They can live in different DLLs, have completely separate code and state, etc.</p>
<p>Unlike the APIs that I discussed in the previous posts, objects are not registered with the API registry. Instead there are API functions for creating and destroying them. So there might be a function in an API somewhere for creating a heap allocator:</p>
<pre><code>struct tm_heap_i {
    struct tm_allocator_i *(*create_static_heap)(void *buffer, uint64_t size);
    void (*destroy_static_heap)(struct tm_allocator_i *heap);
};
</code></pre>
<p>As another example, a piece of C code implementing a stdlib allocator could look something like this:</p>
<pre><code>static void *stdlib_realloc(struct tm_allocator_o *, void *ptr, uint64_t size)
{
    void *new_ptr = NULL;
    if (size)
        new_ptr = realloc(ptr, size);
    else
        free(ptr);
    return new_ptr;
}

static struct tm_allocator_i stdlib_allocator = {
    NULL,
    stdlib_realloc,
};

static tm_allocator_i *get_stdlib_allocator()
{
    return &amp;stdlib_allocator;
}
</code></pre>
<p>In this case,  <code>get_stdlib_allocator()</code> would be a part of some API exposed through the registry. The user would call this function to get access to the standard allocator. Since the stdlib allocator doesnât use an explicit state, we donât need the <code>inst</code> parameter and can leave it at <code>NULL</code>.</p>
<p>This approach with state and function pointers in a struct is a kind of âC with classesâ approach. You might wonder, if we want classes, why donât we just use C++? We would get some help from the syntax, better type safety and some performance improvements, such as the ability to use inline functions.</p>
<p>First, as already stated in the previous post, we want a standard ABI, which we can only get with C, and we like the simplicity of C APIs.</p>
<p>Second, these objects donât act as any old C++ classes. They use purely abstract interfaces and complete implementation hiding. So they are more like what you would get if you consistently used the <a href="http://web.archive.org/web/20210830070717/http://en.cppreference.com/w/cpp/language/pimpl">PIMPL</a> idiom in C++. We like this, because it gives us a lot of physical and logical decoupling. But it adds a bit of verbosity and a performance cost (no inlined functions, for example). Note though that these costs are more a consequence of the design (abstract/PIMPL) than the language choice (C vs C++).</p>
<h2 id="vtables">Vtables</h2>
<p>One difference between our approach and standard C++ PIMPL is that we donât share <a href="http://web.archive.org/web/20210830070717/https://en.wikipedia.org/wiki/Virtual_method_table">vtables</a> between objects. Instead, itâs as if each object has a little vtable of its own. With shared vtables, the API would look more like:</p>
<pre><code>struct tm_allocator_obj {
    struct tm_allocator_vtable *vtable;
    struct tm_allocator_o *state;
};

struct tm_allocator_vtable {
    void *(*realloc)(struct tm_allocator_obj *this, void *ptr, uint64_t size);
};
</code></pre>
<p>Shared vtables are essentially a memory optimization. Instead of having the method pointers in every object, we just store them once and put a pointer to that in the object. The cost is an extra level of indirection which makes things a bit more verbose (unless we have syntactic sugar for using the vtable, as we do in C++).</p>
<p>The shared vtable optimization makes sense when you have lots and lots of objects with the same API â then all those function pointers start to add up. However, if you have lots and lots of things I would argue that the abstract PIMPL design doesnât make sense anyway. In that case, you donât want to address your objects individually, you want to process things in bulk. Implementing a âparticleâ as an âobjectâ will be inefficient no matter how you do it. A particle should just be some data in a SIMD vector or on the GPU.</p>
<p>Our view is that anything that we have lots and lots of should be managed <em>behind</em> the APIs, in raw buffers. The objects that we manage at the API layer are high-level objects that we have relatively few of, which makes it worth it to pay the extra cost of abstraction. For example, in the particle case, the API level would expose a <em>particle manager</em>, but that manager would keep track of individual particles behind the scene â storing them in CPU or GPU buffers as necessary.</p>
<p>Since we have relatively few of these high-level objects and memory is plentiful these days, we donât really need the vtable optimization and can go for the simpler approach of storing the function pointers directly in each object.</p>
<p>This is very different from the âeverything is an objectâ philosophy of object-oriented design, which is why we talk about it as âdata-driven designâ. With our approach we pay the cost of abstraction where it makes sense (for high-level objects) and avoid it otherwise.</p>
<h2 id="forward-declarations">Forward declarations</h2>
<p>In our system, modules make use of other modules through forward declaration. For example, the compression API that I talked about in the last post probably needs to use an allocator to allocate the buffer for the decompressed data (I conveniently skipped that in the previous post). With this, the API might look something like this:</p>
<pre><code>struct tm_allocator_i;

struct tm_piper_compression_i {
    uint8_t *(*compress)(struct tm_allocator_i *a, const uint8_t *raw, uint64_t raw_size);
    uint8_t *(*decompress)(struct tm_allocator_i *a, const uint8_t *compressed, uint64_t raw_size);
};
</code></pre>
<p>Since the allocator interface is only passed as a pointer, we donât need to include the <code>allocator.h</code> header in our module header. In fact, our header doesnât need to include <em>any</em> other headers at all. This is nice, because it keeps the compile times down, as I talked about in a <a href=" ../../post/physical-design/">previous post</a>. And more importantly, it keeps the <em>complexity</em> down. You can look at a single header file and most of what you need to know in order to understand and use the module is right there in front of you.</p>
<p>We went down this design path because it seemed to be the best way to build a flexible, modular, decoupled system. As an unexpected benefit, I find that I really enjoy programming in this style. The clear and very strict separation between interfaces and implementations makes it easy to focus on a small part of the system without being distracted by the whole, systems can be easily mocked for testing purposes, etc.</p>
<h2 id="plugging-it-in">Plugging it in</h2>
<p>The organization of our header files and the API registry provide most of the foundation for the plugin system. We only need to add a few snippets of code for loading and unloading shared libraries.</p>
<p>A <em>plugin</em> in The Machinery is just a DLL (or whatever shared library representation is used on the platform) that exposes two functions for loading and unloading the plugin:</p>
<pre><code>void load_xxx(struct tm_api_registry_i *reg, bool reload);
void unload_xxx(struct tm_api_registry_i *reg, bool reload);
</code></pre>
<p>Here <code>xxx</code> is the name of the plugin. So for our <code>piper_compression</code> plugin, the functions would be called <code>load_piper_compression()</code> and <code>unload_piper_compression()</code>.</p>
<p>Having these names be unique for each plugin allows us to link the plugins either statically or dynamically, depending on the kind of executable we are building.</p>
<p>The <code>load_xxx()</code> function uses the API registry to query for any APIs that the plugin needs and then registers the APIs provided by the plugin with the registry. The <code>unload_xxx()</code> function removes the pluginâs modules from the registry.</p>
<p>The plugin loader simply loads a plugin DLL, gets the address to the <code>load_xxx()</code> function through <code>GetProcAddress()</code>  or <code>dlsym()</code> and then calls that function to register the plugin.</p>
<p>The <code>reload</code> flag in the API is used for hot-reloading. We donât <em>require</em> plugins to be hot-reloadable, but we want to give them the <em>option</em> to be. It is up to each plugin to decide whether it makes sense for that plugin to support hot-reloading or not. When hot-reloading of a plugin is enabled, the plugin system will automatically detect changes to the DLL and hot-reload it. So as a developer, you can just recompile the DLL in Visual Studio, or whatever tool you are using, and the plugin will hot-reload and you will see the effects of your changes immediately.</p>
<p>To hot-reload a plugin the manager first calls <code>load_xxx()</code> on the new DLL with the <code>reload</code> flag set and then it calls <code>unload_xxx()</code> on the old DLL with the <code>reload</code> flag set. This gives the plugin a chance to transfer state between the old and new instance of the DLL. Again, it is up to the plugin author to decide how ambitious she wants to be with preserving state. An FTP plugin might for example decide to cancel all ongoing transfers if the plugin is reloaded, or, it could be more ambitious and keep-alive the existing transfers by transferring the data and the responsibility for maintaining them to the new DLL instance.</p>
<p>Users of an API can ask the API registry to be notified whenever that API is loaded or unloaded. At that point they can store the new API pointer and go through any other reload protocol required by the API (restarting FTP transfers if they are auto-cancelled by the reload).</p>
<h2 id="windows-woes">Windows woes</h2>
<p>Unfortunately, implementing a hot-reload DLL system on Windows is not trivial, because of Windows file locking. Windows will lock the DLL when you load it â preventing you from overwriting it when you recompile. In addition, the Visual Studio Debugger will lock the PDB when debugging DLLs and keep them locked indefinitely (even if you unload the DLL). Locked PDBs canât be overwritten either, which prevents you from recompiling. Here are some possible ways of dealing with it:</p>
<ul>
<li>Copy the DLL and the PDB to a temporary directory before loading them. Unfortunately, this doesnât work if the DLL depends on something in its current directory (such as another DLL).</li>
<li>Copy the DLL to a random file name in the same directory before loading it. Unfortunately, this doesnât work for the PDB, because the absolute path name of the PDB is hardcoded in the DLL during compile, so if we copy the PDB, the debugger will still load the original.</li>
<li>Move the old PDB to a random file name as a pre-compile step. This works, because we can move the file even though it is locked and Visual Studio can still use it. Unfortunately, this triggers a recompile of the PDB every time we compile the project, because the system no longer sees a PDB there.</li>
<li>Generate a random name for the PDB for each compile through a <code>/pdb</code>  flag with a <code>%random%</code> macro in the name. This works pretty well, except the compiler output is not super neat. Instead of nicely matching <code>piper.dll</code> and <code>piper.pdb</code> files, it will have <code>piper.dll</code> and <code>piper.39429834.pdb</code>.</li>
<li><a href="http://web.archive.org/web/20210830070717/https://blog.molecular-matters.com/2017/05/09/deleting-pdb-files-locked-by-visual-studio/">Write code to explicitly force Visual Studio to release its lock of the PDB file.</a></li>
</ul>
<p>Our options are a bit limited by the fact that we want both the old and the new DLL to be loaded at the same time, in order to do the state transfer. So we canât unload the old DLL (and thus unlock it) before loading the new one. If we did the state transfer some other way â for example by serializing the state out to a buffer â that restriction would be lifted. But we donât want to force plugin developers to do state transfer through serialization. (With our system they can still do that if they want to, of course.)</p>
<p>Currently we use the following approach:</p>
<ul>
<li>Copy the DLL to a random name in the same directory before loading it. This prevents file locks on the DLLs.</li>
<li>Move the PDB to a random name as a pre-compile step. This preserves the debuggerâs use of the PDB and allows us to build a new one.</li>
<li>Copy the moved PDB back to the original PDB name as another pre-compile step. This prevents Visual Studio from rebuilding the DLL every time because the PDB is missing.</li>
<li>Clean up old random DLLs and PDBs when the executable is launched.</li>
</ul>
<p>As an example of the hot-reload mechanism, our unit test system supports hot-reload of plugins. If you run the unit tests with the <code>-r</code> flag, they will run in hot reload mode. The unit tester registers a callback with the API registry and whenever a <code>TM_UNIT_TEST_API_NAME</code> API is reloaded â it will rerun the unit tests for that module.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/authors/niklas" class="text-decoration-none">Niklas Gray</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210830070717/https://twitter.com/share?text=Little%20Machines%20Working%20Together%20%28Part%202%29Â -Â Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2flittle-machines-working-together-part-2%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210830070717/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2flittle-machines-working-together-part-2%2f&amp;description=Little%20Machines%20Working%20Together%20%28Part%202%29" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/finding-alignment/">Finding Alignment</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-05-22T00:00:00Z">
                      22 May 2017
                    </time>
                  </h6>
                  <p class="card-text">Finding alignment in your work is imperative to a well-balanced life. There have been too many times when myself and my â¦</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/finding-alignment/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">7 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/little-machines-working-together-part-1/">Little Machines Working Together (Part 1)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-05-16T00:00:00Z">
                      16 May 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>What we are building at <em>Our Machinery</em> is not so much a single monolithic thing as a collection of little things that can â¦</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/little-machines-working-together-part-1/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">6 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/a-modern-rendering-architecture/">A modern rendering architecture</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2017-05-09T00:00:00Z">
                      9 May 2017
                    </time>
                  </h6>
                  <p class="card-text"><p>Over the last few weeks I&rsquo;ve been deep into exploration mode, sketching out and prototyping the rendering API that â¦</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/a-modern-rendering-architecture/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">8 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/little-machines-working-together-part-2/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210830070717/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210830070717/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/cdn-cgi/l/email-protection#43332a2d24032c36312e22202b2a2d26313a6d202c2e" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210830070717/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 07:07:17 Aug 30, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:53:48 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 2265.574
  exclusion.robots: 0.116
  exclusion.robots.policy: 0.106
  cdx.remote: 0.083
  esindex: 0.011
  LoadShardBlock: 129.667 (3)
  PetaboxLoader3.resolve: 111.616 (4)
  PetaboxLoader3.datanode: 42.185 (4)
  CDXLines.iter: 20.99 (3)
  load_resource: 29.089
-->