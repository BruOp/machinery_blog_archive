











<!DOCTYPE html>
<html lang="en">

<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/manifest.json">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../../images/favicon.ico">
  <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="The implementation of the selection highlighting system in The Machinery."/>
  

  
  <meta name="twitter:card" content="summary_large_image"/>
  
  
  <meta name="twitter:image" content="../../images/selection__outline.gif"/>
  
  <meta name="twitter:title" content="Borderland between Rendering and Editor — Part 3: Selection Highlighting">
  <meta name="twitter:description" content="The implementation of the selection highlighting system in The Machinery."/>
  
  <meta name="twitter:site" content="@ourmachinery"/>

  
  <meta property="og:title" content="Borderland between Rendering and Editor — Part 3: Selection Highlighting · Our Machinery"/>
  <meta property="og:site_name" content="Our Machinery"/>
  <meta property="og:url" content=" ../../post/borderland-part-3-selection-highlighting/"/>
  
  <meta property="og:image" content="../../images/selection__outline.gif"/>
  
  
  <meta property="og:description" content="The implementation of the selection highlighting system in The Machinery."/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content=" 2020-09-22T00:00:00Z"/>
  

  <title>Borderland between Rendering and Editor — Part 3: Selection Highlighting &middot; Our Machinery</title>

  

  
  
  <link type="text/css" rel="stylesheet" href="../../css/bootstrap.min.css" integrity="" print"/>
  <link type="text/css" rel="stylesheet" href="../../css/style.min.css" integrity="" print"/>
  

  
  
  <link href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
  

  <link rel="canonical" href="index.html"/>

  
  
  <script>

      
    
    

  </script>
  

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>

  
  <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="../../cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script type="text/javascript" src="../../js/bootstrap.bundle.min.js" integrity=""></script>
  <script type="text/javascript" src="../../js/page.min.js" integrity=""></script>
  
  
  








<script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20210804183202/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "url":"http:\/\/web.archive.org\/web\/20210804183202\/https:\/\/ourmachinery.com\/",
        "email":"ping@ourmachinery.com",
        "image": {
            "@type": "ImageObject",
            "url": "/images/full-logo.png"
        },
        "name":"Our Machinery",
        "description":""
    },
    "author": {
        "@type": "Person",
        "name": "Tobias Persson",
        "email": "ping@ourmachinery.com",
        
        "website":"http:\/\/web.archive.org\/web\/20210804183202\/https:\/\/ourmachinery.com\/"
        
        
        
    },
    "headline": "Borderland between Rendering and Editor — Part 3: Selection Highlighting",
    "name": "Borderland between Rendering and Editor — Part 3: Selection Highlighting",
    "wordCount":  1376 ,
    "timeRequired": "PT7M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": " ../../post/borderland-part-3-selection-highlighting/",
    "datePublished": "2020-09-22T00:00Z",
    "dateModified": "2020-09-22T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://web.archive.org/web/20210804183202/https://ourmachinery.com/selection__outline.gif"
    },
    
    
    "description": "The implementation of the selection highlighting system in The Machinery."
}
    </script>


</head>
<body class="d-flex flex-column min-vh-100">
       <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="../../">
          <img src="../../images/full-logo.png" alt="Our Machinery Logo" width="250" height="75">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block" id="navbarCollapse">
          <ul class="navbar-nav  ms-auto mb-2 mb-md-0 align-items-center">
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li>
            <li class="nav-item">
               
            </li>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                About
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/product.html" aria-label="Link The Machinery">The Machinery</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/about.html" aria-label="Link About Us">About Us</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/press.html" aria-label="Link Press Kit">Press Kit</a>
                </li>
                
              </ul>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle " id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Learning &amp; Support
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Link API Documentation" target="_blank">API Documentation</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/tutorials/" aria-label="Link Tutorials">Tutorials</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/videos.html" aria-label="Link Videos">Videos</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/samples.html" aria-label="Link Sample Projects">Sample Projects</a>
                </li>
                
                <li>
                  <a class="dropdown-item " href="http://web.archive.org/web/20210804183202/https://github.com/OurMachinery/themachinery-public/issues" aria-label="Link Issue Tracker" target="_blank">Issue Tracker</a>
                </li>
                
              </ul>
            </li>
            
            
            
             
            
            
            
            <li class="nav-item dropdown" style="height:40px;min-width:58px;">
              <a class="text-yellow fs-1 signed-in-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="person-circle-outline"></ion-icon>
              </a>
              <a class="text-yellow fs-1 signed-out-only" style="line-height: 1;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <ion-icon name="log-in-outline"></ion-icon>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/sign-in.html">Sign In <ion-icon class="ms-auto" name="log-in-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-out-only d-flex align-items-center" href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/sign-up.html">Sign Up <ion-icon class="ms-auto" name="create-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/profile.html">Profile <ion-icon class="ms-auto" name="person-outline"></ion-icon></a></li>
                <li><a class="dropdown-item signed-in-only d-flex align-items-center" role="button" onclick="signOut(); return false;">Sign Out <ion-icon class="ms-auto" name="log-out-outline"></ion-icon></a></li>
              </ul>
            </li>
            
          </ul>
        </div>
      </div>


      <div id="sidebar" tabindex="-1" role="dialog" aria-modal="false" class="b-sidebar b-sidebar-right collapse shadow bg-dark text-light vh-100">
        <header class="b-sidebar-header">
          <button type="button" aria-label="Close" class="fs-1 btn btn-default text-light float-start" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar-1" aria-expanded="false" aria-label="Toggle navigation">
          <span class="icon icon-close"></span>
        </button>
        <div class=" d-flex justify-content-center">
        <a href="../../"><img src="../../images/full-logo.png" class="om-logo p-2 mb-2 mt-2" alt="Our Machinery Logo" width="100" height="75"></a>
  </div>
      </header>
          <div class="b-sidebar-body overflow-auto">
            <div class="card text-primary">
              
              <div class="card-body d-flex justify-content-center signed-out-only">
                <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/sign-in.html" aria-label="Login" class="btn btn-outline-primary me-2" style="flex: 1;"><span class="icon icon-user align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign In</span></a>
                <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/sign-up.html" aria-label="Register Account" class="btn btn-outline-primary" style="flex: 1;"><span class="icon icon-edit align-middle"></span> <span class="align-middle text-uppercase font-monospace">Sign Up</span></a>
              </div>
              
              <div class="card-body d-flex justify-content-center signed-in-only">
                <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/profile.html" aria-label="Open Profile" class="btn btn-outline-primary me-2 d-flex" style="max-height: 56; min-height: 56px;"><span class="align-middle align-self-center text-uppercase font-monospace">Profile</span></a>
                <a onclick="signOut(); return false;" class="btn btn-outline-primary  d-flex" style="max-height: 56; min-height: 56px;"><span class="icon icon-lock align-middle align-self-center"></span> <span class="align-middle align-self-center text-uppercase font-monospace">Logout</span></a>
              </div>
            </div>
            <div class="accordion mt-0" id="accordion-menu">
              
              
              
              
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id2">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id2" aria-expanded="false" aria-controls="#collapse-id2">
                      About
                    </button>
                  </h2>
                  <div id="collapse-id2" class="accordion-collapse collapse" aria-labelledby="heading-id2" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/product.html">The Machinery</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/about.html">About Us</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/press.html">Press Kit</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id3">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id3" aria-expanded="false" aria-controls="#collapse-id3">
                      Learning &amp; Support
                    </button>
                  </h2>
                  <div id="collapse-id3" class="accordion-collapse collapse" aria-labelledby="heading-id3" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/apidoc/apidoc.html">API Documentation</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/tutorials/">Tutorials</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/videos.html">Videos</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/samples.html">Sample Projects</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://github.com/OurMachinery/themachinery-public/issues">Issue Tracker</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
              
                <div class="accordion-item  bg-light">
                  <h2 class="accordion-header" id="heading-id4">
                    <button class="accordion-button bg-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-id4" aria-expanded="false" aria-controls="#collapse-id4">
                      Community
                    </button>
                  </h2>
                  <div id="collapse-id4" class="accordion-collapse collapse" aria-labelledby="heading-id4" data-bs-parent="#accordion-menu">
                    <div class="accordion-body p-0">
                      <div class="list-group border-0">
                        
                          <a class="list-group-item list-group-item-action border-0 " href=" ../../post/">Blog</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://discord.gg/SHHSZaH">Discord</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://github.com/OurMachinery/themachinery-public/discussions">Forum</a>
                        
                          <a class="list-group-item list-group-item-action border-0 " href="http://web.archive.org/web/20210804183202/https://anchor.fm/ourmachinery">Podcast</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                
              
            </div>
    </div>
  
    <footer class="b-sidebar-footer w-100">
      <div class="d-flex flex-row">
        <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/tutorials/" aria-label="Opens Tutorial" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Tutorials</span></a>
        <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/apidoc/apidoc.html" aria-label="Opens API Documentation" type="button" class="btn btn-outline-light m-1" style="flex: 1"> <span class="align-middle text-uppercase font-monospace">Documentation</span></a>
    </div>

    
 

 
  </footer>
  
    </div>

    </nav>
  <main>


<section class="mt-5 container">

  <article class="post">
    <header class="post-blog mx-auto">
      <div class="mb-5 clearfix" role="group" aria-label="Basic example">
          <a href=" ../../" type="button" class="btn btn-primary float-start">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
          </a>
          <div class="float-end">
          
           
        </div>
        </div>
      </div>

      <div class="d-grid d-md-flex gap-2 pb-3 pb-md-0 mb-2">
        <div class="flex-grow-1">
          <h1>Borderland between Rendering and Editor — Part 3: Selection Highlighting</h1>
        </div>
      </div>

      <p>
        <time class="post-date" datetime=" 2020-09-22T00:00:00Z">
          Sep 22, 2020
        </time>
      </p>



    </header>

    <section class="text-break post-blog mx-auto">
      <p>We’ve reached the third post in this series about often overlooked rendering features typically
needed when building editors for 3D content creation. In the previous two posts we have covered
<a href=" ../../post/borderland-between-rendering-and-editor-part-1/">grid rendering</a> and
<a href=" ../../post/borderland-part-2-picking/">picking</a>, go check them out if you
haven’t already.</p>
<p>In today’s post we will take a look at our selection highlighting effect:</p>
<figure class="figure d-block">
    <img class="figure-img img-fluid rounded d-block" alt="The Machinery uses a yellow outline effect to indicate the editor selection state." src="../../images/selection__outline.gif"/>
    <figcaption class="figure-caption fs-5">
        <h4>The Machinery uses a yellow outline effect to indicate the editor selection state.</h4>
    </figcaption>
  </figure>
<p>As you can see we render a yellow outline around the selected objects in the scene. Using some kind
of outline effect is a pretty standard approach for doing selection highlighting and is used by most
of the game engines I know of. As you will see it’s fairly straight forward to implement but as
Google returned surprisingly little information on the subject, I thought I would share the details
of our implementation.</p>
<p>Before we begin let’s list some of our requirements:</p>
<ul>
<li>
<p>Outlines should be easy to read, feel crisp, and have decent anti-aliasing.</p>
</li>
<li>
<p>Outlines should maintain a constant width of 1 pixel.</p>
</li>
<li>
<p>Outlines should be composited after post-processing.</p>
</li>
<li>
<p>If the selected object is covered by an object that’s not part of the selection, we still want to
display the outline but make it appear a bit dimmed out.</p>
</li>
<li>
<p>Any shader should be able to easily implement support for displaying the outline effect.</p>
</li>
</ul>
<p>From the editor’s perspective, we want to keep things as simple as possible, essentially we have a
set of entity IDs holding the selection state that we pass to all renderable components.</p>
<p>To make it simple to enable outlines for a renderable component (i.e., a component implementing the
<a href=" ../../post/ecs-and-rendering/">tm_ci_render_i</a> interface) we rely on using a
<a href=" ../../post/the-machinery-shader-system-part-3/#systems"><em>shader system</em></a>. In
the inner loop of the component, we simply check if the ID of the owning entity is present in the
selection state. If it is, we enable a shader system called <code>selection_system</code>. Any shader
implementing support for the <code>selection_system</code> will activate an additional rendering pass if the
system has been enabled for that particular draw call. This additional pass will render the object
into a selection buffer with its own depth stencil target. The selection buffer is a single channel
render target that the shader writes some kind of unique ID to. Currently, we are using the lower
eight bits of the Entity ID as we already have that
<a href=" ../../post/borderland-part-2-picking/">available</a>.</p>
<p>Since we don’t have any dependencies on the rest of the scene, we can render to the selection buffer
at any point during the frame as long as we are done before we get to the composition stage of the
outline effect.</p>
<h2 id="composition">Composition</h2>
<p>The actual outline effect runs as a fullscreen pass blended on top of the output color buffer for
the viewport. The shader expects to have access to the selection buffer, the depth buffer associated
with the selection buffer, as well as the regular depth buffer used when rendering the scene.</p>
<p>We begin by generating an anti-aliased alpha value for the outline:</p>
<pre><code class="language-hlsl" data-lang="hlsl">// Generate outline by comparing IDs between current pixel and surrounding
// pixels. This will collect 4x4 IDs but we will only be using the upper
// 3x3 taps.
float4 id0 = sel_id.GatherRed(clamp_point, input.uv, int2(-2, -2));
float4 id1 = sel_id.GatherRed(clamp_point, input.uv, int2( 0, -2));
float4 id2 = sel_id.GatherRed(clamp_point, input.uv, int2(-2,  0));
float4 id3 = sel_id.GatherRed(clamp_point, input.uv, int2( 0,  0));

// Throw away unused taps and merge into two float4 and a center tap
id2.xw = id1.xy;
float id_center = id3.w;
id3.w = id0.y;

// Count ID misses and average together. a becomes our alpha of the outline.
static const float avg_scalar = 1.f / 8.f;
float a = dot(float4(id2 != id_center), avg_scalar);
a += dot(float4(id3 != id_center), avg_scalar);
</code></pre><p>So basically what we are interested in doing is to compare the ID of the current pixel with the IDs
of the surrounding 8 pixels. The more they differ, the closer we are to an outline edge. Instead of
fetching 9 individual samples from the selection buffer (<code>sel_id</code>), we use <code>GatherRed()</code>.</p>
<p>If you haven’t used any of the <code>Gather4</code>-instructions before the concept is pretty simple. Instead
of issuing 4 point sample instructions, we can rely on the texture filtering hardware to fetch 2x2
texels from a single color channel (in this case red) and return each tap in the X, Y, Z,
W-components. One thing to watch out for is that the order of the returned taps can be quite easy to
mess up, they are returned in
<a href="http://web.archive.org/web/20210804183202/https://microsoft.github.io/DirectX-Specs/d3d/archive/D3D11_3_FunctionalSpec.htm#22.4.2%20gather4">counter</a><a href="http://web.archive.org/web/20210804183202/https://microsoft.github.io/DirectX-Specs/d3d/archive/D3D11_3_FunctionalSpec.htm#22.4.2%20gather4">-</a><a href="http://web.archive.org/web/20210804183202/https://microsoft.github.io/DirectX-Specs/d3d/archive/D3D11_3_FunctionalSpec.htm#22.4.2%20gather4">clockwise
order as
follows</a>:</p>
<pre><code class="language-hlsl" data-lang="hlsl">X: (-0.5, +0.5)
Y: (+0.5, +0.5)
Z: (+0.5, -0.5)
W: (-0.5, -0.5)
</code></pre><p>While this is enough to generate a decently looking outline we also want to dim the outline if it’s
behind an object that isn’t part of the selection state.</p>
<p>A simple and brute force take on how to achieve that would be to just sample the scene depth and the
depth of the selection buffer. If the depth value of the selection buffer is behind the scene depth
buffer, just multiply the alpha value (<code>a</code>) with some factor to dim the outline.</p>
<p>Unfortunately, things aren’t quite that easy. First of all, we want the outline to be able to bleed
over the selected object and since the selected object is likely to appear both in the scene depth
buffer and the selection depth buffer, the brute force approach will start dimming it as soon as it
intersects the object. But our bigger problem is TAA.</p>
<p>We use Temporal Anti-Aliasing as our default anti-aliasing method in The Machinery, which means that
our scene depth buffer is not temporarily stable as every frame we are applying a different post
projection sub-pixel jitter to all our vertices when rendering our scene. So as soon as we need to
do any kind of depth testing against the scene depth <em><strong>after</strong></em> we have resolved TAA we’re doomed
to have a flickering problem. Our outline effect is no exception.</p>
<p>One little hack that has proven fairly successful to hide most of the flickering and at the same
time allow the outline to bleed over the edges of the selected objects is to take more samples from
the selection depth buffer around the current pixel and then use the depth value closest to the
camera when doing the comparison to the scene depth:</p>
<pre><code class="language-hlsl" data-lang="hlsl">// If alpha is zero, early out.
[branch]
if (a == 0) {
    output.color = float4(0,0,0,0);
    return output;
}

// To allow outline to bleed over objects and combat TAA jittering artifacts
// sample depth of selection buffer in a 4x4 neighborhood and pick closest
// depth.
float4 dtap0 = sel_depth.GatherRed(cp, input.uv, int2(-2, -2));
float4 dtap1 = sel_depth.GatherRed(cp, input.uv, int2( 0, -2));
float4 dtap2 = sel_depth.GatherRed(cp, input.uv, int2(-2,  0));
float4 dtap3 = sel_depth.GatherRed(cp, input.uv, int2( 0,  0));
float d0 = max(dtap0.x, max(dtap0.y, max(dtap0.z, dtap0.w)));
float d1 = max(dtap1.x, max(dtap1.y, max(dtap1.z, dtap1.w)));
float d2 = max(dtap2.x, max(dtap2.y, max(dtap2.z, dtap2.w)));
float d3 = max(dtap3.x, max(dtap3.y, max(dtap3.z, dtap3.w)));
float d = max(d0, max(d1, max(d2, d3)));

// Sample scene depth, scn_depth holds linear depth.
float scnd = scn_depth.Sample(cp, input.uv).r;

// Linearize d and compare it with scene depth to determine if outline is
// behind an object.
float2 near_far = load_camera_near_far();
bool visible = linearize_depth(d, near_far.x, near_far.y) &lt;= scnd;

// If outline is hidden, reduce its alpha value to 30%.
a *= visible ? 1.f : 0.3f;

output.color = float4(outline_color, a);
</code></pre><p>The above code is fairly self-explanatory, one thing might be worth clarifying though. As we use
reverse depth in The Machinery we use <code>max()</code> instead of <code>min()</code> to find the clip space depth value
closest to the camera. The depth values stored in <code>scn_depth</code> are stored as linear depth values,
hence we need to “linearize” <code>d</code> before we compare it with <code>scnd</code>.</p>
<p>That’s all there is to it really. A future improvement would be to support different outline colors
depending on the editor’s selection state. That would require us to write the outline color (or some
kind of identifier of the color) into the selection buffer and do a weighted sum of the neighborhood
pixels in the fullscreen pass to determine the final outline color. Feels like low-hanging fruit but
I haven’t bothered implementing it as we so far haven’t had the need for that.</p>
<p>This wraps up the final part of this series. Hope you’ve enjoyed it.</p>
      


<section>
  <h5>by <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/authors/tobias" class="text-decoration-none">Tobias Persson</a></h5>
</section>


    </section>
    <footer class="mt-5 mb-5">
      <hr>

      <div class="d-flex">
    <div class="me-auto">
        <a href=" ../../post" type="button" class="btn btn-primary">
            <ion-icon name="chevron-back-outline" class="align-middle" style="padding-right:0.2em"></ion-icon> <span class="align-middle">All Blogs</span>
        </a>
    </div>
    
    <a class="icon icon-twitter me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804183202/https://twitter.com/share?text=Borderland%20between%20Rendering%20and%20Editor%20%e2%80%94%20Part%203%3a%20Selection%20Highlighting - Our%20Machinery&amp;url=https%3a%2f%2fourmachinery.com%2fpost%2fborderland-part-3-selection-highlighting%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon icon-pinterest me-1" style="font-size: 1.2em" href="http://web.archive.org/web/20210804183202/https://pinterest.com/pin/create/button/?url=https%3a%2f%2fourmachinery.com%2fpost%2fborderland-part-3-selection-highlighting%2f&amp;description=Borderland%20between%20Rendering%20and%20Editor%20%e2%80%94%20Part%203%3a%20Selection%20Highlighting" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    
</div>

      <div class="mt-5">
        

<p>The comment system uses a session cookie to keep track of your signed-in status. This cookie is
created when you sign in with GitHub. If you don't sign in, no cookie is created.</p>




      </div>

      
      <div class="container mb-5 mt-5">
        <div class="row">
          <h3>Previous Posts</h3>
          <hr>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          
              <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2020-8/">The Machinery Beta — August 2020 (version 2020.8)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-08-28T00:00:00Z">
                      28 Aug 2020
                    </time>
                  </h6>
                  <p class="card-text">Hope you all have managed to get some rest and relaxation during these strange times. We are wrapping up our summer …</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2020-8/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">4 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/beta-2020-7/" class="text-decoration-none"><img src="../../images/beta_20_7__expanding_inherited.gif" class="card-img-top" alt="The Machinery Beta — July 2020 (version 2020.7)"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/beta-2020-7/">The Machinery Beta — July 2020 (version 2020.7)</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-07-20T00:00:00Z">
                      20 Jul 2020
                    </time>
                  </h6>
                  <p class="card-text">We are starting our summer vacations at Our Machinery, so this release is a little lighter than usual. Hope that you too …</p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/beta-2020-7/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">3 min</small>
                </div>
              </div>
        </div>
         <div class="col">
              <div class="card om-post-preview shadow-sm">
                
                <a href=" ../../post/prototypes-in-the-machinery/" class="text-decoration-none"><img src="../../images/proto__drilling_down.gif" class="card-img-top" alt="Prototypes in The Machinery"></a>
                
                <div class="card-body">
                  <h5 class="card-title"><a class="text-decoration-none" href=" ../../post/prototypes-in-the-machinery/">Prototypes in The Machinery</a></h5>
                  <h6 class="card-subtitle mb-2 text-muted">
                    <time class="post-date" datetime=" 2020-06-29T00:00:00Z">
                      29 Jun 2020
                    </time>
                  </h6>
                  <p class="card-text"><p>Most game engines have some way of creating reusable entities — i.e., <em>template</em> entities that can
be placed multiple …</p></p>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2">
                  <div class="btn-group">
                    <a href=" ../../post/prototypes-in-the-machinery/" type="button" class="btn btn-lg btn-outline-primary">Read</a>
                  </div>
                  <small class="text-muted">22 min</small>
                </div>
              </div>
        </div>
        
      </div>
      </div>
    </footer>
  </article>

</section>

</main>

<footer class="container-fluid mt-auto page-footer-bg">
    <div class="mx-auto d-flex justify-content-center w-100 pt-5 pb-5">
        <img alt="trees" src=" ../../post/borderland-part-3-selection-highlighting/&#32;https:/ourmachinery.com/images/trees.png" style="height: 84.38px; width: 150px;">
    </div>
    <div class="page-info">
        <p class="float-end">
            
            <a href="http://web.archive.org/web/20210804183202/https://twitter.com/ourmachinery" target="_blank" class="icon icon-twitter fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804183202/https://instagram.com/ourmachinery" target="_blank" class="icon icon-instagram fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/index.xml" target="_blank" class="icon icon-feed fs-4"></a>
            
            <a href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/cdn-cgi/l/email-protection#0a7a63646d4a657f78676b696263646f787324696567" target="_blank" class="icon icon-mail fs-4"></a>
            
        </p>
        <p>&copy; Our Machinery 2021 <a style="text-decoration:none; margin-left:1em;" href="http://web.archive.org/web/20210804183202/https://ourmachinery.com/privacy.html">Privacy Policy</a></p>
    </div>
</footer>

<script type="module" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="../../unpkg.com/ionicons@5.4.0/dist/ionicons/ionicons.js"></script>
</body>

</html><!--
     FILE ARCHIVED ON 18:32:02 Aug 04, 2021 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:52:12 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 132.171
  exclusion.robots: 0.094
  exclusion.robots.policy: 0.085
  cdx.remote: 0.071
  esindex: 0.01
  LoadShardBlock: 99.361 (3)
  PetaboxLoader3.datanode: 90.751 (4)
  CDXLines.iter: 21.497 (3)
  load_resource: 948.396
  PetaboxLoader3.resolve: 900.466
-->