<!DOCTYPE html>
<html lang="en-us">
<head>

<script type="text/javascript" src="../../_static/js/bundle-playback.js@v=KTqwAcYd" charset="utf-8"></script>

<script type="text/javascript">
  
  __wm.wombat("http://ourmachinery.com/post/one-button-source-code-builds/","20170830095246","http://web.archive.org/","web"../../_static/",

</script>
<link rel="stylesheet" type="text/css" href="../../_static/css/banner-styles.css@v=fantwOh2.css" />
<link rel="stylesheet" type="text/css" href="../../_static/css/iconochive.css@v=qtvMKcIJ.css" />
<!-- End Wayback Rewrite JS Include -->


    <link rel="apple-touch-icon" sizes="180x180" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/favicon-16x16.png">
    <link rel="manifest" href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/manifest.json">
    <link rel="mask-icon" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

    

<meta name="twitter:card" content="summary_large_image"/>


    
        <meta name="twitter:image" content="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/machinery-logo.png"/>
    
    <meta name="twitter:title" content="One-button source code builds">
    <meta name="twitter:description" content=""/>




<meta name="twitter:site" content="@ourmachinery"/>


  	<meta property="og:title" content="One-button source code builds · Our Machinery"/>
  	<meta property="og:site_name" content="Our Machinery"/>
  	<meta property="og:url" content="http://web.archive.org/web/20170830095246/http://ourmachinery.com/post/one-button-source-code-builds/"/>
    
        <meta property="og:image" content="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/machinery-logo.png"/>
    

    
    <meta property="og:description" content=""/>
  	<meta property="og:type" content="article"/>
    <meta property="article:published_time" content="2017-04-24T00:00:00Z"/>

    
    

    <title>One-button source code builds &middot; Our Machinery</title>

    
    <meta name="description" content=""/>
    

    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link rel="shortcut icon" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/apple-touch-icon.png"/>

    <link rel="stylesheet" type="text/css" href="http://web.archive.org/web/20170830095246cs_/http://ourmachinery.com/css/screen.css"/>
    <link rel="stylesheet" type="text/css" href="http://web.archive.org/web/20170830095246cs_/http://ourmachinery.com/css/nav.css"/>
    <link rel="stylesheet" type="text/css" href="http://web.archive.org/web/20170830095246cs_/http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata"/>

    

    
        <link href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/index.xml" rel="alternate" type="application/rss+xml" title="Our Machinery"/>
    
    <meta name="generator" content="Hugo 0.19"/>

    <link rel="canonical" href="index.html"/>

    
      
    
    <script type="application/ld+json">
{
    "@context": "http://web.archive.org/web/20170830095246/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": 
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "url": ,
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": One-button source code builds,
    "name": One-button source code builds,
    "wordCount": 1562,
    "timeRequired": "PT8M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": http://ourmachinery.com/post/one-button-source-code-builds/,
    "datePublished": 2017-04-24T00:00Z,
    "dateModified": 2017-04-24T00:00Z,
    
    "keywords": ,
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": http://ourmachinery.com/post/one-button-source-code-builds/
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//web.archive.org/web/20170830095246/http://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-96359368-1', 'auto');
      

    </script>
    

    
</head>
<body class="nav-closed">

    <link rel="stylesheet" href="http://web.archive.org/web/20170830095246cs_/http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
    <script src="http://web.archive.org/web/20170830095246js_/http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

  <div style="display:none"><img src="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/machinery-logo.png"/></div>

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/index.xml">Subscribe</a> </div>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      
          <a class="menu-button icon-newsletter" href="http://web.archive.org/web/20170830095246/https://docs.google.com/forms/d/e/1FAIpQLSeZGObGQvFTSJRGuDE_-dQNSAamRcoddkN-p5t7DZMk0XTllg/viewform?usp=sf_link">&nbsp;&nbsp;Newsletter</a>
      
      
        <a class="menu-button icon-feed" href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/index.xml">&nbsp;&nbsp;RSS</a>
      
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">One-button source code builds</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2017-04-24T00:00:00Z">
            Apr 24, 2017
          </time>
        
         
        </section>
    </header>

    <section class="post-content">
      <p>Something I’ve been wanting to do for a long time is to create a one-button setup and build system. I.e., on a fresh machine, on any supported platform, it should be possible to type a single command that will first fetch, install and setup everything that is needed to build, and then perform the build and print the result.</p>

<p></p>

<p>Why? Mainly to make the source code more friendly to new users. Complicated, or even worse, incomplete build instructions are not a nice way to get started with a project. A user faced with something like:</p>

<ul>
<li>Install CMAKE</li>
<li>Set these environment variables</li>
<li>Make sure you have this exact version of Ruby installed and in your <code>$PATH</code></li>
<li>Download these libraries and put them in these directories</li>
<li>Install doxygen</li>
<li>Add these git-hooks to your <code>.git</code> repository</li>
<li>…</li>
</ul>

<p>may just give up, unless they are already deeply invested in the project.</p>

<p>Building something, running it and playing with it is the first step to understanding how it works. And we want to encourage curious people to experiment with our stuff.</p>

<p>Short and simple build instructions are good, but having a single button that you can just “press to build” is even better.</p>

<p>Programs that <em>do</em> things are always better than instructions that tell you <em>how</em> to do things. Having <a href="http://web.archive.org/web/20170830095246/https://clang.llvm.org/docs/ClangFormat.html">clang-format</a> format you code is better than having a document with source formatting guidelines. Similarly, a tool that <em>builds</em> your code is better than a document with instructions on <em>how to build</em> your code. Documents can be vague and ambiguous whereas executable code is always precise. Documents easily get out-of-date,  whereas if the executable gets out of date and no longer does the right thing, it is easily discovered. Executables can be put into pipelines, enabling further automatization and they free the people from rote memorization of rules and guidelines, so that their minds can be used solely for programming, the way they were intended to.</p>

<p>In the past, there was always something that prevented me from achieving full automatization — some legacy code that was just too complicated to rewrite. But that’s the nice thing about starting from scratch with Our Machinery. We get a chance to revisit old hang-ups and do them right from the beginning.</p>

<h2 id="picking-a-language">Picking a language</h2>

<p>The first question is what language to use for our one-button build script.</p>

<p>In the past I’ve used Ruby for similar scripting tasks, but Ruby doesn’t come pre-installed on all platforms that we support; If you have to install Ruby before you can run the build script then it isn’t really a one-button solution. In addition, Ruby easily runs into version problems and <a href="http://web.archive.org/web/20170830095246/http://guides.rubygems.org/ssl-certificate-update/">gem troubles</a> and I’m just not as fond of the language as I used to be.</p>

<p>We could use the built-in scripting environments (<code>bash</code> on OS X, <code>.bat</code> files on Windows), but that would mean having to maintain multiple scripts and also, those languages are kind of horrible to program in.</p>

<p>Something I&rsquo;ve discovered when working on large projects before is that you really need to watch out for language proliferation, or before you know it your code will be a mix of C++, Lua, C#, JavaScript, CMAKE, Ruby, Python, Go and Rust. This creates all kinds of inefficiencies. It raises the barrier of entry for anyone wanting to understand the source code. The same routines will often have to be implemented multiple times in different languages and data has to be marshalled back and forth between them. So even though some time might be saved initially by using a scripting language instead of C for some administrative task, in the long run we believe it will be a net loss.</p>

<p>At Our Machinery we have taken the drastic decision to use C and (simple) C++ for everything. (As you know from <a href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/post/physical-design/">my last blog post</a>, we like drastic decisions.) So tools, helpers, tests and experiments will all be written in C, using our <code>foundation</code> APIs which provide platform independent utilities for memory allocation, networking, file system access, etc.</p>

<p>The advantage of this is that to understand the code, you only need to know one language and everything can be debugged together in the same debugger. In addition, it is a good litmus test for our <code>foundation</code> libraries. If we can’t easily write our various little tools and snippets on top of these libraries, then something is clearly wrong. Eating your own dog food is the best way of making sure that it tastes good.</p>

<p>Following this rule, our build script is just a simple one-file C program built on top of the <code>foundation</code> libraries. It compiles to a platform specific executable which we call <code>tmbuild</code>. We distribute these executables together with the source code and to build the source you just need to run <code>tmbuild</code> in the source code directory. Currently, it has the following options for customizing the build:</p>

<pre><code class="language-txt">Usage: tmbuild [OPTION]...

    -h
    --help
        Display this help and exit.

    -t &lt;tool&gt;
    --build-tool &lt;tool&gt;
        Specifies the tool to use for building [gmake, xcode4, vs2017].
        If not specified, the platform default is used.

    -c &lt;config&gt;
    --config &lt;config&gt;
        Specifies the configuration to build [Debug, Release]. Default is
        Debug.
</code></pre>

<p>We expect to add more options in the future as we support more kinds of builds.</p>

<h2 id="operation-of-tmbuild">Operation of tmbuild</h2>

<p>To build the project, <code>tmbuild</code> goes through these steps:</p>

<ol>
<li>Install dependencies</li>
<li>Install build tool (Xcode, Visual Studo, …)</li>
<li>Run <a href="http://web.archive.org/web/20170830095246/https://premake.github.io/">premake</a></li>
<li>Build</li>
<li>Run unit tests</li>
<li>Generate documentation</li>
</ol>

<p>The <em>dependencies</em> are all the third-party libraries and binaries that we need in order to build the project in the current configuration. For example <code>premake5</code> is a dependency, because we use it to generate solution files for the build tools.</p>

<p>The dependencies are specified in a JSON file called <code>packages.json</code> , which looks like this:</p>

<pre><code>{
    &quot;premake-osx&quot;: {
        &quot;build-platforms&quot;: [&quot;osx&quot;],
        &quot;lib&quot;: &quot;premake-5.0.0-alpha11-macosx&quot;,
        &quot;role&quot;: &quot;premake5&quot;
    },
    ...
}
</code></pre>

<p>The build tool has the concept of a <code>build-platform</code> (the platform we use when we run the build tool) and a <code>target-platform</code> (the platform that we are targeting the build for). Only the dependencies that are needed for the current build and target platforms are installed.</p>

<p>Each version of each dependency is identified by a unique string, such as <code>premake-5.0.0-alpha11-macosx</code> . To install the dependency we simply download <code>premake-5.0.0-alpha11-macosx.zip</code>  from the web server where we host the libraries and unzip it into the library directory. The library directory is <code>./lib</code> by default, but can be configured with a <code>TM_LIB_DIR</code> environment variable.</p>

<p>We use our own HTTP API from the <code>foundation</code> for downloading the files. Since we don’t have zip file support in our <code>foundation</code> (yet) we rely on platform specific tools for unzipping. On OS X we use the pre-installed <code>unzip</code> program. On Windows we use <a href="http://web.archive.org/web/20170830095246/http://www.7-zip.org/">7-Zip</a>. Since 7-Zip is not installed by default, we host an uncompressed version of the 7-Zip <a href="http://web.archive.org/web/20170830095246/http://www.7-zip.org/download.html">standalone executable</a> <code>7za.exe</code> on the library server. This way, we can bootstrap the install process on Windows by first downloading <code>7za.exe</code> and then use that to unzip the other dependencies.</p>

<p>Since each dependency has a unique name, it is easy to check if a dependency already exists in the library directory and in that case skip installation. To make a new version of library, you simply create a new zip file with the updated version, upload that to the library server and check in an updated <code>package.json</code> file with the new library name. <code>package.json</code> is committed together with the rest of the source code, so we will always fetch a version of the dependencies that matches the version of the code that we are currently building.</p>

<p>Setting up the build tool is the only step of the process that is not fully automated. The reason for this is that we can’t know which version of Visual Studio the user wants to install (Community, Professional or Enterprise) and it is kind of rude to run the Visual Studio installer on their machine without asking. Instead, in this step we just detect whether Visual Studio is installed or not. If it isn’t, we print an informational message and open up the web page for <a href="http://web.archive.org/web/20170830095246/https://www.visualstudio.com/downloads/">downloading and installing Visual Studio</a>.</p>

<p>After this, the rest of the steps are easy. We run <em>premake5</em> from the library directory where we downloaded it in order to set up the solution files, then we just launch the selected build tool to build the platform binaries. If we run into an error at any point, we abort with an error message.</p>

<p>After the binaries have been generated we run our unit tests to make sure no errors were introduced and then run our documentation generator to generate API documentation. Following our principle to write everything in C, these tools are themselves simple one-file C programs. If there is enough interest, I will talk more about these tools in a future blog post.</p>

<h2 id="using-tmbuild">Using tmbuild</h2>

<p>I’m currently using <code>tmbuild</code> as my main build command. I work mostly in <a href="http://web.archive.org/web/20170830095246/https://atom.io/">Atom</a>, using Visual Studio and Xcode only for debugging.</p>

<p>I have an <code>.atom-build.js</code> configuration file that sets up <code>tmbuild</code> as the build tool for <a href="http://web.archive.org/web/20170830095246/https://atom.io/packages/build">atom-build</a>. It captures error output both from the compiler and from our unit tests, so that <a href="http://web.archive.org/web/20170830095246/https://atom.io/packages/linter">atom-linter</a> can pick up the errors. Whenever I want to compile the code, I just press <code>F9</code> and a second or so later I have the compile and unit test results as well as freshly generated documentation:</p>


<figure>
    
        <img src="http://web.archive.org/web/20170830095246im_/http://ourmachinery.com/images/unit-test.png"/>
    
    
    <figcaption>
        <h4>atom-build capturing a unit test failure</h4>
        
    </figcaption>
    
</figure>
    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="http://web.archive.org/web/20170830095246/http://ourmachinery.com/">Niklas Gray</a></h4>
  
  
  <div class="author-meta">
    
    
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="http://web.archive.org/web/20170830095246/https://twitter.com/share?text=One-button%20source%20code%20builds - Our%20Machinery&amp;url=http%3a%2f%2fourmachinery.com%2fpost%2fone-button-source-code-builds%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="http://web.archive.org/web/20170830095246/https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fourmachinery.com%2fpost%2fone-button-source-code-builds%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://web.archive.org/web/20170830095246/http://pinterest.com/pin/create/button/?url=http%3a%2f%2fourmachinery.com%2fpost%2fone-button-source-code-builds%2f&amp;description=One-button%20source%20code%20builds" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="http://web.archive.org/web/20170830095246/https://plus.google.com/share?url=http%3a%2f%2fourmachinery.com%2fpost%2fone-button-source-code-builds%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    


  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="index.html">Our Machinery</a> </section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://web.archive.org/web/20170830095246js_/http://ourmachinery.com/js/jquery.js"></script>
    <script type="text/javascript" src="http://web.archive.org/web/20170830095246js_/http://ourmachinery.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://web.archive.org/web/20170830095246js_/http://ourmachinery.com/js/index.js"></script>
    
</body>
</html>

<!--
     FILE ARCHIVED ON 09:52:46 Aug 30, 2017 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:53:53 Aug 01, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 225.657
  exclusion.robots: 0.106
  exclusion.robots.policy: 0.097
  RedisCDXSource: 135.741
  esindex: 0.012
  LoadShardBlock: 70.946 (3)
  PetaboxLoader3.datanode: 111.901 (4)
  CDXLines.iter: 15.91 (3)
  load_resource: 72.012
  PetaboxLoader3.resolve: 21.56
-->